<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BORail Live Timetable</title>
  <!-- iOS add-to-home support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="BORail" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Crect width='100%25' height='100%25' fill='%230a0a0a'/%3E%3Ccircle cx='90' cy='90' r='70' fill='%23ff3b30'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-family='Arial' font-size='64' fill='white'%3EB%3C/text%3E%3C/svg%3E" />
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    :root {
      --bg: #0b0b10;
      --card: #141421;
      --muted: #a0a3ad;
      --text: #f3f4f8;
      --accent: #8a8fff;
      --success: #3ddc84;
      --danger: #ff5a5f;
      --warning: #ff9500;
      --line-Red: #ff3b30;
      --line-Gold: #ffcc00;
      --line-Green: #34c759;
      --line-Orange: #ff9500;
      --line-Blue: #007aff;
      --line-Pink: #ff2d55;
      --line-Brown: #a2845e;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
        margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Inter, Helvetica, Arial, sans-serif;
        background: radial-gradient(1200px 600px at 50% -200px, #151528, #0a0a12) fixed;
        color: var(--text);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        padding-bottom: calc(78px + env(safe-area-inset-bottom));
    }
    header {
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: saturate(180%) blur(14px);
      background: rgba(10,10,18,.65);
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding-top: env(safe-area-inset-top);
    }
    .wrap { max-width: 860px; margin: 0 auto; padding: 12px 16px; }
    .title { font-weight: 800; letter-spacing: .2px; font-size: 22px; }
    .subtle { color: var(--muted); font-size: 12px; }

    .controls { display: grid; gap: 10px; grid-template-columns: 1fr auto; align-items: center; margin-top: 10px; }
    select, button, input[type="time"] {
      width: 100%; appearance: none; border: 1px solid rgba(255,255,255,.12); background: var(--card);
      color: var(--text); border-radius: 14px; padding: 12px 40px 12px 12px; font-size: 16px;
    }
    .seg { display: flex; gap: 10px; align-items: center; }
    .pill { padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); font-size: 12px; }
    .pill.late-night {
      border-color: var(--line-Gold);
      color: var(--line-Gold);
      box-shadow: 0 0 0 2px rgba(255, 204, 0, 0.20) inset;
    }

    .grid { display: grid; gap: 12px; margin-top: 14px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.03), transparent), var(--card); border: 5px solid rgba(255,255,255,.06); border-radius: 18px; padding: 14px; }

    .list { display: grid; gap: 15px; }
    .row { display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center; padding: 18px 15px; border-radius: 14px; border: 1px solid rgba(255,255,255,.06); background: rgba(255,255,255,.02); }

    /* Make <details class="row"> expand correctly on mobile */
    details.row { display: block; }
    details.row > summary {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
      cursor: pointer;
      list-style: none;
      outline: none;
    }
    details.row > summary::-webkit-details-marker { display: none; }
    details.row[open] > summary { margin-bottom: 10px; }
    .dot { width: 14px; height: 14px; border-radius: 50%; box-shadow: 0 0 0 3px rgba(255,255,255,.08) inset; }
    .lineTag { font-weight: 560; letter-spacing: .3px; }
    .dest { color: var(--muted); font-size: 13px; }
    .mins { font-weight: 700; font-variant-numeric: tabular-nums; }

    .banner { display:flex; align-items:center; justify-content:space-between; gap: 10px; padding: 12px; border:1px dashed rgba(255,255,255,.10); border-radius:14px; background: rgba(255,255,255,.03); }
    .adbox { height: 64px; border-radius: 12px; background: linear-gradient(90deg, rgba(255,255,255,.06), transparent), #0b0b10; border:1px solid rgba(255,255,255,.08); flex:1; display:flex; align-items:center; justify-content:center; color: var(--muted); font-size:12px; }

    footer { color: var(--muted); font-size: 12px; padding: 40px 0 80px; text-align: center; }

    @media (min-width: 700px) { .grid { grid-template-columns: 2fr 1fr; } }

    /* Route stops list styling */
    .stops-list { 
      list-style: none; 
      margin: 0; 
      padding-left: 0; 
      line-height: 1.4;
    }
    .stop-item {
      position: relative;
      margin: 0;
      padding: 8px 0 8px 32px;
      border-left: 2px solid rgba(255,255,255,0.14);
      margin-left: 8px;
    }
    .stop-item:last-child {
      border-left-color: transparent;
    }
    .stop-item .stop-icon {
      position: absolute;
      left: -9px;
      top: 8px;
      width: 18px;
      height: 18px;
    }
    .stop-item .stop-icon svg {
      width: 18px;
      height: 18px;
    }
    .stop-item.current .stop-name {
      color: var(--success);
      font-weight: 600;
    }
    .stop-item.current.delayed .stop-name {
      color: var(--warning);
    }
    .stop-item.past {
      opacity: 0.5;
    }
    .stop-item.en-route .stop-name {
      color: var(--accent);
    }
    
    .stop-time-main {
      font-size: 13px;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
      margin-bottom: 2px;
    }
    .stop-time-main.delayed .scheduled {
      text-decoration: line-through;
      opacity: 0.6;
    }
    .stop-time-main .new-time {
      color: var(--warning);
      margin-left: 6px;
    }
    .stop-name {
      font-size: 14px;
      color: var(--text);
    }
    .stop-details {
      font-size: 11px;
      color: var(--muted);
      margin-top: 3px;
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .stop-details .clock-icon {
      width: 12px;
      height: 12px;
      vertical-align: middle;
      margin-right: 3px;
      opacity: 0.7;
    }
    .stop-details .detail-item {
      display: inline-flex;
      align-items: center;
    }
    
    .en-route-banner {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(138, 143, 255, 0.1);
      border: 1px solid rgba(138, 143, 255, 0.3);
      border-radius: 8px;
      margin: 6px 0 10px 0;
      font-size: 12px;
      color: var(--accent);
    }
    .en-route-banner svg {
      width: 16px;
      height: 16px;
    }

    /* Train Info Box styling */
    .train-info-box {
      background: rgba(138, 143, 255, 0.08);
      border: 1px solid rgba(138, 143, 255, 0.25);
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 10px;
    }
    .train-info-header {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .train-info-header .route-code {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .train-info-details {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .train-info-details svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }
    .train-info-details .model {
      color: var(--text);
      font-weight: 500;
    }
    .train-info-details .lead-car {
      color: var(--accent);
      font-weight: 600;
    }

    /* Compact view styling */
    .compact-view {
      padding: 0 0 0 4px;
    }
    .compact-stop {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 4px 0;
    }
    .compact-stop .compact-time {
      font-size: 13px;
      color: var(--muted);
      font-variant-numeric: tabular-nums;
      min-width: 42px;
    }
    .compact-stop .compact-time.delayed .scheduled {
      text-decoration: line-through;
      opacity: 0.6;
    }
    .compact-stop .compact-time .new-time {
      color: var(--warning);
      display: block;
      font-size: 12px;
    }
    .compact-stop .compact-icon {
      width: 18px;
      height: 18px;
    }
    .compact-stop .compact-icon svg {
      width: 18px;
      height: 18px;
    }
    .compact-stop .compact-name {
      font-size: 14px;
      font-weight: 500;
    }
    .compact-stop.at-station .compact-name {
      color: var(--success);
    }
    .compact-stop.at-station.delayed .compact-name {
      color: var(--warning);
    }
    
    .mid-stops-btn {
      background: none;
      border: 0;
      padding: 8px 4px 8px 56px;
      color: var(--accent);
      font: inherit;
      font-size: 13px;
      cursor: pointer;
      display: block;
      text-align: left;
      width: 100%;
    }
    .mid-stops-btn:hover {
      text-decoration: underline;
    }

    /* Slide animation */
    .slide {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 350ms ease, opacity 250ms ease;
    }
    .slide.open {
      opacity: 1;
    }

    .linklike { 
      background: none; border: 0; padding: 0; 
      color: var(--accent); font: inherit; cursor: pointer;
    }

    /* Bottom tab bar */
    .tabbar {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 20;
      display: flex;
      justify-content: space-around;
      align-items: center;
      flex-wrap: nowrap;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(180,180,180,0.20);
      backdrop-filter: saturate(180%) blur(14px);
    }

    .tabbar a {
      flex: 1;
      min-width: 0;
      text-decoration: none;
      color: var(--muted);
      text-align: center;
      display: flex;
      justify-content: center;
    }

    .tabbar .item {
      display: grid;
      gap: 6px;
      justify-items: center;
      font-size: 12px;
    }

    .tabbar .item img {
      width: 26px; height: 26px;
      display: block;
      opacity: .8;
      filter: grayscale(100%);
    }

    .tabbar a.active {
      color: var(--accent);
    }

    .tabbar a.active img {
      opacity: 1;
      filter: none;
    }
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">BORail Live Timetable</div>
      <div class="subtle" id="nowText">—</div>
      <div class="controls">
        <select id="stationSelect" aria-label="Choose station"></select>
        <div class="seg">
          <span class="pill" id="serviceState">Service: Normal</span>
          <button id="refreshBtn" title="Refresh">↻</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <div class="card">
        <div class="banner" style="margin-bottom:12px;">
          <div>Upcoming trains</div>
          <div class="seg">
            <label class="subtle" for="limitSelect">Show</label>
            <select id="limitSelect">
              <option value="5">5</option>
              <option value="8">8</option>
              <option value="12">12</option>
            </select>
          </div>
        </div>
        <div id="arrivals" class="list"></div>
      </div>

      <aside class="card">
        <div class="banner" style="margin-bottom:12px;">
          <div class="subtle">Sponsored</div>
          <div class="pill">Ad</div>
        </div>
        <div class="adbox">
          <img src="ad2.png" alt="Advertisement" style="max-width:100%; max-height:64px; border-radius:10px;">
        </div>
        <div style="height:10px"></div>
        <div class="adbox">
          <a href="https://youtube.com/theemfanner" target="_blank" rel="noopener">
            <img src="ad1.png" alt="Promote YouTube Channel" style="max-width:100%; max-height:64px; border-radius:10px;">
          </a>
        </div>
      </aside>
    </section>

    <section class="card" style="margin-top:12px;">
      <details>
        <summary class="subtle">About this app</summary>
        <p style="color:var(--muted); line-height:1.5">This is a fictional live timetable for a Minecraft metro with 66 stations. Services are labeled like a subway (e.g., (A) local and <A> express) and times are computed on-device from the current time and service patterns. Add this site to your iPhone Home Screen to use it like a native app.</p>
      </details>
    </section>
  </main>

  <footer>© BORail • Built for iPhone • Works offline after first load | Version 40</footer>
  
  <nav class="tabbar" role="navigation" aria-label="Primary">
    <a class="active" href="index.html">
      <div class="item">
        <img src="timetableicon.png" alt="" width="26" height="26" />
        <span>Timetable</span>
      </div>
    </a>
    <a href="map.html">
      <div class="item">
        <img src="mapicon.png" alt="" width="26" height="26" />
        <span>Map</span>
      </div>
    </a>
    <a href="https://sites.google.com/view/borail-mc/home" target="_blank" rel="noopener">
      <div class="item">
        <img src="websiteicon.png" alt="" width="26" height="26" />
        <span>Information</span>
      </div>
    </a>
    <a href="status.html">
      <div class="item">
        <img src="statusicon.png" alt="" width="26" height="26" />
        <span>Status</span>
      </div>
    </a>
  </nav>

  <script>
  // ---------------------------
// SVG ICONS (inline)
// ---------------------------
const ICONS = {
  clock: `<svg class="clock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="12" cy="12" r="10"/>
    <path d="M12 6v6l4 2"/>
  </svg>`,
  pinGreen: `<svg viewBox="0 0 24 24" fill="none">
    <path d="M12 22s-7-4.5-7-11a7 7 0 1 1 14 0c0 6.5-7 11-7 11z" stroke="#3ddc84" stroke-width="2"/>
    <circle cx="12" cy="11" r="2.5" fill="#3ddc84"/>
  </svg>`,
  pinOrange: `<svg viewBox="0 0 24 24" fill="none">
    <path d="M12 22s-7-4.5-7-11a7 7 0 1 1 14 0c0 6.5-7 11-7 11z" stroke="#ff9500" stroke-width="2"/>
    <circle cx="12" cy="11" r="2.5" fill="#ff9500"/>
  </svg>`,
  pinGray: `<svg viewBox="0 0 24 24" fill="none">
    <path d="M12 22s-7-4.5-7-11a7 7 0 1 1 14 0c0 6.5-7 11-7 11z" stroke="#a0a3ad" stroke-width="2"/>
    <circle cx="12" cy="11" r="2.5" fill="#a0a3ad"/>
  </svg>`,
  pinDim: `<svg viewBox="0 0 24 24" fill="none" opacity="0.4">
    <path d="M12 22s-7-4.5-7-11a7 7 0 1 1 14 0c0 6.5-7 11-7 11z" stroke="#a0a3ad" stroke-width="2"/>
    <circle cx="12" cy="11" r="2.5" fill="#a0a3ad"/>
  </svg>`
};

// ---------------------------
// SEEDED RANDOM NUMBER GENERATOR
// ---------------------------
function seededRandom(seed) {
  let h = 2166136261 >>> 0;
  const s = String(seed);
  for (let i = 0; i < s.length; i++) {
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return function() {
    h = Math.imul(h ^ (h >>> 16), 2246822507);
    h = Math.imul(h ^ (h >>> 13), 3266489909);
    return ((h ^= h >>> 16) >>> 0) / 4294967296;
  };
}

// ---------------------------
// TIME FORMATTING HELPERS
// ---------------------------
function formatTime24(totalMinutes) {
  const h = Math.floor(totalMinutes / 60) % 24;
  const m = Math.floor(totalMinutes % 60);
  return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
}

function formatTime24Full(totalSeconds) {
  let secs = totalSeconds;
  if (secs < 0) secs += 24 * 3600;
  secs = secs % (24 * 3600);
  const h = Math.floor(secs / 3600);
  const m = Math.floor((secs % 3600) / 60);
  const s = Math.floor(secs % 60);
  return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
}

// ---------------------------
// TRAIN CONSIST SYSTEM (UPDATED)
// ---------------------------
const TRAIN_TYPES = {
  'MTC-T 3298': { cars: 3, leadCarRange: [100, 219] },
  'MTC-T 2254': { cars: 4, leadCarRange: [200, 329] },
  'MTC-T 2253': { cars: 4, leadCarRange: [335, 504] },
  'MTC-T 110':  { cars: 2, leadCarRange: [510, 569] },
  'MTC-T 454':  { cars: 3, leadCarRange: [600, 669] },
  'MTC-T 455-2': { model: 'MTC-T 455', cars: 2, leadCarRange: [700, 769] }
};

// Service IDs: A/F/B/C/D/E/G/S + express flag
function getTrainConsist(trainSeed, serviceId, isExpress) {
  const rng = seededRandom(trainSeed + '-consist');
  const roll = rng();

  // Rules from user:
  // - 3298 only for B
  // - 2254 for A/F/S
  // - 2253 for A/F
  // - 110 for G/D
  // - 454 for C
  // - 455 for C/E (2-car only)
  // Car counts:
  // - A/F/S = 4
  // - D/G = 2
  // - B = 3
  // - E = 2
  // - C = 3 or 2 (454=3 only, 455=2 only)

  let model = 'MTC-T 2254';
  let cars = 4;
  let range = TRAIN_TYPES['MTC-T 2254'].leadCarRange;

  if (serviceId === 'B') {
    model = 'MTC-T 3298';
    cars = 3;
    range = TRAIN_TYPES['MTC-T 3298'].leadCarRange;
  } else if (serviceId === 'D' || serviceId === 'G') {
    model = 'MTC-T 110';
    cars = 2;
    range = TRAIN_TYPES['MTC-T 110'].leadCarRange;
  } else if (serviceId === 'E') {
    // E is 2-car, only 455
    model = 'MTC-T 455';
    cars = 2;
    range = TRAIN_TYPES['MTC-T 455-2'].leadCarRange;
  } else if (serviceId === 'C') {
    // C is mix: mostly 454 (3-car) with some 455 (2-car)
    if (roll < 0.75) {
      model = 'MTC-T 454';
      cars = 3;
      range = TRAIN_TYPES['MTC-T 454'].leadCarRange;
    } else {
      model = 'MTC-T 455';
      cars = 2;
      range = TRAIN_TYPES['MTC-T 455-2'].leadCarRange;
    }
  } else if (serviceId === 'A' || serviceId === 'F') {
    // Mix 2253/2254
    if (roll < 0.60) {
      model = 'MTC-T 2253';
      cars = 4;
      range = TRAIN_TYPES['MTC-T 2253'].leadCarRange;
    } else {
      model = 'MTC-T 2254';
      cars = 4;
      range = TRAIN_TYPES['MTC-T 2254'].leadCarRange;
    }
  } else if (serviceId === 'S') {
    // S uses only 2254 (4 cars)
    model = 'MTC-T 2254';
    cars = 4;
    range = TRAIN_TYPES['MTC-T 2254'].leadCarRange;
  }

  const [minCar, maxCar] = range;
  const leadCar = minCar + Math.floor(rng() * (maxCar - minCar + 1));
  return { model, cars, leadCar };
}

// ---------------------------
// 1) DATA MODEL (UPDATED STATIONS + SERVICES)
// ---------------------------
const STATIONS = [
  'Newkirk','Newkirk - Oak Street','Hoganville','Bayview Park','Chelsea Bay','Berwick Hall',
  'Westpoint','Bradford Square','Bradford Bay','Cambridge Central','Atkinson Junction','Garner',
  'Kenilworth','La Vista','Brookfield Lawn','Boylston','Foxston','New Cottage','Whitebranch',
  'Burlington - University of NCU','Port Williamson','Willow Springs','Rockcastle','Cannon View',
  'Ivory Knolls','Djimar','Vanderburg','Ralston-Finch East','Atkins Bridge','Radcliff Fields',
  'Oakville City Airport','Veridia Nexus','Oakville Exchange','Oakville City Center','Oakville Plaza',
  'Leighton Castle','Talmedge Hill','Mount River','Perry Road','Mount Hindsboro','Wood-by-Hike',
  'New Salemview','Millford Heights','Roxbury Landing','East Heights','Alpherst','New Halifax',
  'Tyford Farms','Scottsbury','Ameryville','Scottsdale','Grant Park','Cherrywood','Brandywine',
  'Santa Mora','Greens Corner','Doverville','Orchard Ridge','Groveton','Madisonboro','Hutchinson Point',
  'Vanwood','South Harrington','Harrington City','Carrollton','Hadleigh'
].map((name) => ({ id: name, name }));

const STATION_SET = new Set(STATIONS.map(s => s.id));

// 1.5 minutes (90 seconds) between each station unless overridden
const DEFAULT_SEGMENT_TIME = 1.5;
const segFor = (route) => Array(route.length - 1).fill(DEFAULT_SEGMENT_TIME);

// Line colors kept only for UI accents; we display lettered services + icons
const SERVICE_META = {
  A: { color: '#34c759', localIcon: 'https://raw.githubusercontent.com/onedevlucas/onedevlucas.github.io/main/ALocalIcon.png', expressIcon: 'https://raw.githubusercontent.com/onedevlucas/onedevlucas.github.io/main/AExpressIcon.png' },
  F: { color: '#ff3b30', localIcon: 'https://raw.githubusercontent.com/onedevlucas/onedevlucas.github.io/main/FLocalIcon.png', expressIcon: 'https://raw.githubusercontent.com/onedevlucas/onedevlucas.github.io/main/FExpressIcon.png' },
  B: { color: '#007aff', localIcon: 'https://raw.githubusercontent.com/onedevlucas/onedevlucas.github.io/main/BLocalIcon.png', expressIcon: 'https://raw.githubusercontent.com/onedevlucas/onedevlucas.github.io/main/BExpressIcon.png' },
  C: { color: '#ff2d55', localIcon: 'https://raw.githubusercontent.com/onedevlucas/onedevlucas.github.io/main/CLocalIcon.png', expressIcon: null },
  D: { color: '#ff9500', localIcon: 'https://raw.githubusercontent.com/onedevlucas/onedevlucas.github.io/main/DLocalIcon.png', expressIcon: null },
  E: { color: '#a2845e', localIcon: 'https://raw.githubusercontent.com/onedevlucas/onedevlucas.github.io/main/ELocalIcon.png', expressIcon: null },
  G: { color: '#ffcc00', localIcon: 'https://raw.githubusercontent.com/onedevlucas/onedevlucas.github.io/main/GLocalIcon.png', expressIcon: null },
  S: { color: '#c7c7cc', localIcon: 'https://raw.githubusercontent.com/onedevlucas/onedevlucas.github.io/main/SLocalIcon.png', expressIcon: 'https://raw.githubusercontent.com/onedevlucas/onedevlucas.github.io/main/SExpressIcon.png' }
};

// ---------------------------
// ROUTES (UPDATED: no RB01/RP01 etc)
// ---------------------------

const ROUTES = [
  // F local: two branches
  { serviceId:'F', isExpress:false, tag:'LCL', dir:'NB', origin:'Kenilworth', destination:'Newkirk',
    stops:['Kenilworth','Garner','Atkinson Junction','Cambridge Central','Berwick Hall','Chelsea Bay','Bayview Park','Hoganville','Newkirk - Oak Street','Newkirk'] },
  { serviceId:'F', isExpress:false, tag:'LCL', dir:'NB', origin:'Boylston', destination:'Newkirk',
    stops:['Boylston','Brookfield Lawn','La Vista','Atkinson Junction','Cambridge Central','Berwick Hall','Chelsea Bay','Bayview Park','Hoganville','Newkirk - Oak Street','Newkirk'] },
  { serviceId:'F', isExpress:false, tag:'LCL', dir:'SB', origin:'Newkirk', destination:'Kenilworth',
    stops:['Newkirk','Newkirk - Oak Street','Hoganville','Bayview Park','Chelsea Bay','Berwick Hall','Cambridge Central','Atkinson Junction','Garner','Kenilworth'] },
  { serviceId:'F', isExpress:false, tag:'LCL', dir:'SB', origin:'Newkirk', destination:'Boylston',
    stops:['Newkirk','Newkirk - Oak Street','Hoganville','Bayview Park','Chelsea Bay','Berwick Hall','Cambridge Central','Atkinson Junction','La Vista','Brookfield Lawn','Boylston'] },

  // F express
  { serviceId:'F', isExpress:true, tag:'EXP', dir:'NB', origin:'Whitebranch', destination:'Newkirk',
    stops:['Whitebranch','New Cottage','Foxston','Brookfield Lawn','La Vista','Atkinson Junction','Berwick Hall','Hoganville','Newkirk - Oak Street','Newkirk'] },
  { serviceId:'F', isExpress:true, tag:'EXP', dir:'SB', origin:'Newkirk', destination:'Whitebranch',
    stops:['Newkirk','Newkirk - Oak Street','Hoganville','Berwick Hall','Atkinson Junction','La Vista','Brookfield Lawn','Foxston','New Cottage','Whitebranch'] },

  // G shuttle (local only)
  { serviceId:'G', isExpress:false, tag:'LCL', dir:'EB', origin:'Bradford Bay', destination:'Berwick Hall',
    stops:['Bradford Bay','Bradford Square','Westpoint','Berwick Hall'], segmentTimes:[1.5,1.5,2.0] },
  { serviceId:'G', isExpress:false, tag:'LCL', dir:'WB', origin:'Berwick Hall', destination:'Bradford Bay',
    stops:['Berwick Hall','Westpoint','Bradford Square','Bradford Bay'], segmentTimes:[1.5,1.5,1.5] },

  // S local / express
  { serviceId:'S', isExpress:false, tag:'LCL', dir:'NB', origin:'Ralston-Finch East', destination:'Burlington - University of NCU',
    stops:['Ralston-Finch East','Vanderburg','Djimar','Ivory Knolls','Cannon View','Rockcastle','Willow Springs','Burlington - University of NCU'] },
  { serviceId:'S', isExpress:false, tag:'LCL', dir:'SB', origin:'Burlington - University of NCU', destination:'Ralston-Finch East',
    stops:['Burlington - University of NCU','Willow Springs','Rockcastle','Cannon View','Ivory Knolls','Djimar','Vanderburg','Ralston-Finch East'] },
  { serviceId:'S', isExpress:true, tag:'EXP', dir:'NB', origin:'Ralston-Finch East', destination:'Newkirk',
    stops:['Ralston-Finch East','Cannon View','Rockcastle','Willow Springs','Burlington - University of NCU','Newkirk - Oak Street','Newkirk'] },
  { serviceId:'S', isExpress:true, tag:'EXP', dir:'SB', origin:'Newkirk', destination:'Ralston-Finch East',
    stops:['Newkirk','Newkirk - Oak Street','Burlington - University of NCU','Willow Springs','Rockcastle','Cannon View','Ralston-Finch East'] },

  // A local / express
  { serviceId:'A', isExpress:false, tag:'LCL', dir:'NB', origin:'Mount River', destination:'Newkirk',
    stops:['Mount River','Talmedge Hill','Oakville Plaza','Oakville Exchange','Oakville City Airport','Radcliff Fields','Atkins Bridge','Cannon View','Burlington - University of NCU','Newkirk'] },
  { serviceId:'A', isExpress:false, tag:'LCL', dir:'SB', origin:'Newkirk', destination:'Mount River',
    stops:['Newkirk','Burlington - University of NCU','Cannon View','Atkins Bridge','Radcliff Fields','Oakville City Airport','Oakville Exchange','Oakville Plaza','Talmedge Hill','Mount River'] },
  { serviceId:'A', isExpress:true, tag:'EXP', dir:'NB', origin:'Mount River', destination:'Port Williamson',
    stops:['Mount River','Talmedge Hill','Oakville Plaza','Oakville Exchange','Oakville City Airport','Atkins Bridge','Cannon View','Willow Springs','Port Williamson'] },
  { serviceId:'A', isExpress:true, tag:'EXP', dir:'SB', origin:'Port Williamson', destination:'Mount River',
    stops:['Port Williamson','Cannon View','Atkins Bridge','Oakville City Airport','Oakville Exchange','Oakville Plaza','Talmedge Hill','Mount River'] },

  // D shuttle (local only)
  { serviceId:'D', isExpress:false, tag:'LCL', dir:'NB', origin:'Oakville City Airport', destination:'Veridia Nexus',
    stops:['Oakville City Airport','Veridia Nexus'], segmentTimes:[1.5] },
  { serviceId:'D', isExpress:false, tag:'LCL', dir:'SB', origin:'Veridia Nexus', destination:'Oakville City Airport',
    stops:['Veridia Nexus','Oakville City Airport'], segmentTimes:[1.5] },

  // C local: two branches
  { serviceId:'C', isExpress:false, tag:'LCL', dir:'SB', origin:'East Heights', destination:'Oakville City Airport',
    stops:['East Heights','Roxbury Landing','Millford Heights','New Salemview','Wood-by-Hike','Mount Hindsboro','Perry Road','Oakville City Airport'] },
  { serviceId:'C', isExpress:false, tag:'LCL', dir:'SB', origin:'East Heights', destination:'Leighton Castle',
    stops:['East Heights','Roxbury Landing','Millford Heights','New Salemview','Wood-by-Hike','Mount Hindsboro','Perry Road','Oakville Exchange','Oakville City Center','Oakville Plaza','Leighton Castle'] },
  { serviceId:'C', isExpress:false, tag:'LCL', dir:'NB', origin:'Oakville City Airport', destination:'East Heights',
    stops:['Oakville City Airport','Perry Road','Mount Hindsboro','Wood-by-Hike','New Salemview','Millford Heights','Roxbury Landing','East Heights'] },
  { serviceId:'C', isExpress:false, tag:'LCL', dir:'NB', origin:'Leighton Castle', destination:'East Heights',
    stops:['Leighton Castle','Oakville Plaza','Oakville City Center','Oakville Exchange','Perry Road','Mount Hindsboro','Wood-by-Hike','New Salemview','Millford Heights','Roxbury Landing','East Heights'] },

  // E local only
  { serviceId:'E', isExpress:false, tag:'LCL', dir:'SB', origin:'Santa Mora', destination:'East Heights',
    stops:['Santa Mora','Brandywine','Cherrywood','Grant Park','Scottsdale','Ameryville','Scottsbury','Tyford Farms','New Halifax','Alpherst','Roxbury Landing','East Heights'] },
  { serviceId:'E', isExpress:false, tag:'LCL', dir:'NB', origin:'East Heights', destination:'Santa Mora',
    stops:['East Heights','Alpherst','New Halifax','Scottsbury','Ameryville','Scottsdale','Grant Park','Cherrywood','Brandywine','Santa Mora'] },

  // B local / express
  { serviceId:'B', isExpress:false, tag:'LCL', dir:'NB', origin:'Oakville Plaza', destination:'Harrington City',
    stops:['Oakville Plaza','Oakville City Center','Oakville Exchange','Perry Road','Mount Hindsboro','Greens Corner','Doverville','Orchard Ridge','Groveton','Madisonboro','Hutchinson Point','Vanwood','South Harrington','Harrington City'] },
  { serviceId:'B', isExpress:false, tag:'LCL', dir:'SB', origin:'Harrington City', destination:'Oakville Plaza',
    stops:['Harrington City','South Harrington','Vanwood','Hutchinson Point','Madisonboro','Groveton','Orchard Ridge','Doverville','Greens Corner','Mount Hindsboro','Perry Road','Oakville Exchange','Oakville City Center','Oakville Plaza'] },
  { serviceId:'B', isExpress:true, tag:'EXP', dir:'NB', origin:'Oakville Plaza', destination:'Hadleigh',
    stops:['Oakville Plaza','Oakville City Center','Oakville Exchange','Greens Corner','Doverville','Orchard Ridge','Groveton','Madisonboro','Hutchinson Point','Vanwood','South Harrington','Harrington City','Carrollton','Hadleigh'] },
  { serviceId:'B', isExpress:true, tag:'EXP', dir:'SB', origin:'Hadleigh', destination:'Oakville Plaza',
    stops:['Hadleigh','Carrollton','Harrington City','South Harrington','Vanwood','Hutchinson Point','Madisonboro','Groveton','Orchard Ridge','Doverville','Greens Corner','Oakville Exchange','Oakville City Center','Oakville Plaza'] }
];

// Validate stops exist (debug-friendly, silent)
ROUTES.forEach(r => {
  r.stops.forEach(s => { if (!STATION_SET.has(s)) console.warn('Unknown station in route:', s, r); });
});

// ---------------------------
// SERVICE WINDOWS (rush/local-only/overnight)
// ---------------------------
const toMin = t => { const [h, m] = t.split(':').map(Number); return h * 60 + m; };
function timeMode(now = new Date()) {
  const nowMin = now.getHours() * 60 + now.getMinutes();
  const rushAM = (nowMin >= toMin('06:30') && nowMin < toMin('09:30'));
  const rushPM = (nowMin >= toMin('17:00') && nowMin < toMin('19:30'));
  const overnight = (nowMin >= toMin('22:30') || nowMin < toMin('06:30'));
  if (overnight) return 'overnight';
  if (rushAM || rushPM) return 'rush';
  return 'local';
}

function isServiceAllowed(route, mode) {
  // Express only during rush
  if (mode !== 'rush' && route.isExpress) return false;

  if (mode === 'overnight') {
    // overnight cuts (10:30PM-6:30AM)
    // - No G
    // - No S (local or express)
    // - No F express
    // - No A express
    // - No D
    // - No B express
    if (route.serviceId === 'G') return false;
    if (route.serviceId === 'S') return false;
    if (route.serviceId === 'D') return false;
    if (route.serviceId === 'F' && route.isExpress) return false;
    if (route.serviceId === 'A' && route.isExpress) return false;
    if (route.serviceId === 'B' && route.isExpress) return false;
  }
  return true;
}

// ---------------------------
// BASE FREQUENCIES (kept similar to original, but governed by timeMode)
// ---------------------------
const LINE_SERVICE = {
  A: { all: [ { start: '05:30', end: '22:30', every: 10 } ] },
  F: { all: [
    { start: '05:30', end: '06:59', every: 10 },
    { start: '07:00', end: '09:59', every: 5 },
    { start: '10:00', end: '15:59', every: 7 },
    { start: '16:00', end: '18:59', every: 5 },
    { start: '19:00', end: '22:30', every: 10 },
  ]},
  B: { all: [
    { start: '05:30', end: '06:59', every: 10 },
    { start: '07:00', end: '09:59', every: 6 },
    { start: '10:00', end: '15:59', every: 8 },
    { start: '16:00', end: '18:59', every: 6 },
    { start: '19:00', end: '22:30', every: 10 },
  ]},
  C: { all: [ { start: '05:30', end: '22:30', every: 8 } ] },
  E: { all: [ { start: '05:30', end: '22:30', every: 10 } ] },
  S: { all: [ { start: '05:30', end: '22:30', every: 10 } ] },
  D: { all: [ { start: '05:30', end: '22:30', every: 12 } ] },
  G: { all: [ { start: '05:30', end: '22:30', every: 12 } ] }
};

const expandDepartures = periods => {
  const out = [];
  periods.forEach(p => {
    let cur = toMin(p.start), end = toMin(p.end);
    while (cur <= end) { out.push(cur); cur += p.every; }
  });
  return out;
};
const cumulative = (seg, i) => { let s = 0; for (let k = 0; k < i; k++) s += seg[k]; return s; };

// ---------------------------
// DELAY SYSTEM (unchanged)
// ---------------------------
function getTrainDelayInfo(trainSeed) {
  const rng = seededRandom(trainSeed + '-delay');
  const roll = rng();
  if (roll < 0.90) {
    return { isDelayed: false, delaySeconds: 0, delayStartStop: -1 };
  } else if (roll < 0.98) {
    const startStop = Math.floor(rng() * 2) + 2;
    return { isDelayed: true, delaySeconds: 60, delayStartStop: startStop };
  } else {
    const delayMins = Math.floor(rng() * 2) + 2;
    const startStop = Math.floor(rng() * 2) + 2;
    return { isDelayed: true, delaySeconds: delayMins * 60, delayStartStop: startStop };
  }
}

function calculateStopTimes(trainSeed, stops, departureMinutes, customSegmentTimes = null) {
  const rng = seededRandom(trainSeed);
  const delayInfo = getTrainDelayInfo(trainSeed);
  const result = [];
  const defaultSegmentSeconds = DEFAULT_SEGMENT_TIME * 60;
  let cumulativeSeconds = 0;

  for (let i = 0; i < stops.length; i++) {
    if (i > 0) {
      if (customSegmentTimes && customSegmentTimes[i - 1] !== undefined) {
        cumulativeSeconds += customSegmentTimes[i - 1] * 60;
      } else {
        cumulativeSeconds += defaultSegmentSeconds;
      }
    }

    const scheduledArrivalSec = departureMinutes * 60 + cumulativeSeconds;
    const arrivalOffset = Math.floor(rng() * 21) + 5; // 5-25s
    const dwellTime = Math.floor(rng() * 9) + 12; // 12-20s

    let delaySec = 0;
    let isStopDelayed = false;
    if (delayInfo.isDelayed && i >= delayInfo.delayStartStop) {
      delaySec = delayInfo.delaySeconds;
      isStopDelayed = true;
    }

    const actualArrivalSec = scheduledArrivalSec + arrivalOffset + delaySec;
    const actualDepartureSec = actualArrivalSec + dwellTime;

    result.push({
      name: stops[i],
      stopIndex: i,
      scheduledArrivalSec,
      actualArrivalSec,
      actualDepartureSec,
      isDelayed: isStopDelayed,
      delaySeconds: isStopDelayed ? delayInfo.delaySeconds : 0
    });
  }

  return { stops: result, hasDelay: delayInfo.isDelayed, delaySeconds: delayInfo.delaySeconds };
}

function getTrainPosition(stopTimes, nowSeconds) {
  const stops = stopTimes.stops;
  if (nowSeconds < stops[0].actualArrivalSec) {
    return { status: 'not-started', nextStop: stops[0].name };
  }
  if (nowSeconds >= stops[stops.length - 1].actualDepartureSec) {
    return { status: 'completed' };
  }
  for (let i = 0; i < stops.length; i++) {
    const stop = stops[i];
    if (nowSeconds >= stop.actualArrivalSec && nowSeconds < stop.actualDepartureSec) {
      return { status: 'at-station', currentStop: stop.name, currentIndex: i, isDelayed: stop.isDelayed };
    }
    if (i < stops.length - 1) {
      const nextStop = stops[i + 1];
      if (nowSeconds >= stop.actualDepartureSec && nowSeconds < nextStop.actualArrivalSec) {
        return { status: 'en-route', fromStop: stop.name, toStop: nextStop.name, fromIndex: i, toIndex: i + 1 };
      }
    }
  }
  return { status: 'unknown' };
}

// ---------------------------
// ARRIVALS ENGINE
// ---------------------------
// ---------------------------
// SINGLE-TRAIN SHUTTLES (G & D)
// ---------------------------
const SINGLE_TRAIN_SHUTTLES = new Set(['G','D']);

// Fixed lead cars per direction (destination)
const FIXED_SHUTTLE_LEAD_CARS = {
  G: { 'Berwick Hall': 545, 'Bradford Bay': 544 },
  D: { 'Veridia Nexus': 540, 'Oakville City Airport': 541 }
};

// Cache station-events for the day so the shuttle behaves like ONE train all day.
const SHUTTLE_EVENTS_CACHE = new Map();
function getShuttleEventsForToday(serviceId) {
  const dayKey = new Date().toISOString().slice(0, 10);
  const key = `${serviceId}-${dayKey}`;
  if (SHUTTLE_EVENTS_CACHE.has(key)) return SHUTTLE_EVENTS_CACHE.get(key);

  const routes = ROUTES.filter(r => r.serviceId === serviceId && !r.isExpress);
  if (routes.length < 2) {
    SHUTTLE_EVENTS_CACHE.set(key, []);
    return [];
  }

  const preferredStartOrigin = (serviceId === 'G') ? 'Bradford Bay'
                           : (serviceId === 'D') ? 'Oakville City Airport'
                           : routes[0].origin;

  let curRoute = routes.find(r => r.origin === preferredStartOrigin) || routes[0];
  let otherRoute = routes.find(r => r !== curRoute) || routes[1];

  const periods = LINE_SERVICE[serviceId]?.all || [{ start: '05:30', end: '22:30', every: 9999 }];
  const dayStart = toMin(periods[0].start);
  const dayEnd = toMin(periods[periods.length - 1].end);

  const rng = seededRandom(`${key}-shuttle-seq`);
  let t0 = dayStart + Math.floor(rng() * 3); // 0..2 min start offset

  const events = [];
  while (t0 <= dayEnd) {
    const seg = curRoute.segmentTimes ? curRoute.segmentTimes : segFor(curRoute.stops);
    let cur = t0;

    for (let i = 0; i < curRoute.stops.length; i++) {
      events.push({
        station: curRoute.stops[i],
        time: cur,
        destination: curRoute.destination,
        serviceId: curRoute.serviceId,
        isExpress: false,
        tag: curRoute.tag,
        color: SERVICE_META[curRoute.serviceId].color,
        stops: curRoute.stops,
        segmentTimes: seg,
        departureMin: t0,
        origin: curRoute.origin,
        dir: curRoute.dir,
        isSingleShuttle: true
      });
      if (i < seg.length) cur += seg[i];
    }

    // Terminal layover (single train turns around)
    const layover = 1 + rng() * 2; // 1..3 min
    t0 = cur + layover;

    // Swap direction
    const tmp = curRoute;
    curRoute = otherRoute;
    otherRoute = tmp;
  }

  SHUTTLE_EVENTS_CACHE.set(key, events);
  return events;
}

function tripsForRoute(routeDef) {
  const periods = LINE_SERVICE[routeDef.serviceId]?.all || [];
  const dep = expandDepartures(periods);
  const seg = routeDef.segmentTimes ? routeDef.segmentTimes : segFor(routeDef.stops);

  // Stagger branches slightly to reduce perfectly synced results
  const branchSeed = `${routeDef.serviceId}-${routeDef.tag}-${routeDef.origin}-${routeDef.destination}`;
  const rng = seededRandom(branchSeed);
  const offset = Math.floor(rng() * 3); // 0..2 min offset
  const deps = dep.map(t => t + offset);

  const out = [];
  for (const t0 of deps) {
    let cur = t0;
    for (let i = 0; i < routeDef.stops.length; i++) {
      out.push({
        station: routeDef.stops[i],
        time: cur,
        destination: routeDef.destination,
        serviceId: routeDef.serviceId,
        isExpress: routeDef.isExpress,
        tag: routeDef.tag,
        color: SERVICE_META[routeDef.serviceId].color,
        stops: routeDef.stops,
        segmentTimes: seg,
        departureMin: t0,
        origin: routeDef.origin
      });
      if (i < seg.length) cur += seg[i];
    }
  }
  return out;
}

function arrivalsForStation(stationId, now = new Date()) {
  const nowMinRaw = now.getHours() * 60 + now.getMinutes();
  const mode = timeMode(now);

  // Build candidate arrivals for next 6 hours (same as before)
  const horizon = 6 * 60;

  const stationName = stationId;
  const out = [];
  const handledShuttles = new Set();

  ROUTES.forEach(r => {
    if (!isServiceAllowed(r, mode)) return;

    // G and D are single-train shuttles: generate ONE shared sequence for the whole day.
    if (SINGLE_TRAIN_SHUTTLES.has(r.serviceId)) {
      if (handledShuttles.has(r.serviceId)) return;
      handledShuttles.add(r.serviceId);

      const trips = getShuttleEventsForToday(r.serviceId);
      for (const trip of trips) {
        if (trip.station !== stationName) continue;

        // Normalize for "after midnight" handling so sorting works
        let arr = trip.time;
        let nowMin = nowMinRaw;
        if (mode === 'overnight') {
          // Treat 00:00-06:29 as 24:00-30:29 for sorting
          if (arr < toMin('06:30')) arr += 1440;
          if (nowMinRaw < toMin('06:30')) nowMin += 1440;
        }

        const minsAway = arr - nowMin;
        if (minsAway >= -1 && minsAway <= horizon) {
          // Filter out trains terminating at selected station
          if (trip.destination === stationName) continue;
          out.push({ ...trip, timeMin: arr, minsAway, mode });
        }
      }
      return;
    }

    const trips = tripsForRoute(r);

    for (const trip of trips) {
      if (trip.station !== stationName) continue;
      // Normalize for "after midnight" handling so sorting works
      let arr = trip.time;
      let nowMin = nowMinRaw;
      if (mode === 'overnight') {
        // Treat 00:00-06:29 as 24:00-30:29 for sorting
        if (arr < toMin('06:30')) arr += 1440;
        if (nowMinRaw < toMin('06:30')) nowMin += 1440;
      }
      const minsAway = arr - nowMin;
      if (minsAway >= -1 && minsAway <= horizon) {
        // Filter out trains terminating at selected station
        if (trip.destination === stationName) continue;
        out.push({
          ...trip,
          timeMin: arr,
          minsAway,
          mode
        });
      }
    }
  });

  out.sort((a, b) => a.timeMin - b.timeMin);
  return out;
}

// ---------------------------
// UI RENDERING
// ---------------------------
const stationSelect = document.getElementById('stationSelect');
const arrivalsEl = document.getElementById('arrivals');
const nowText = document.getElementById('nowText');
const limitSelect = document.getElementById('limitSelect');
const refreshBtn = document.getElementById('refreshBtn');
const serviceState = document.getElementById('serviceState');

const openDetails = new Set();
const expandedStops = new Set();

function renderStations() {
  const sorted = [...STATIONS].sort((a, b) =>
    a.name.localeCompare(b.name, 'en', { sensitivity: 'base' })
  );

  stationSelect.innerHTML = sorted
    .map(s => `<option value="${s.id}">${s.name}</option>`)
    .join('');

  // default to first alphabetically
  stationSelect.value = sorted[0].id;
}

function renderClock() {
  const now = new Date();
  nowText.textContent = `Now: ${formatTime24Full(now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds())}`;
  const mode = timeMode(now);
  serviceState.textContent = (mode === 'rush') ? 'Service: Rush (LCL+EXP)' :
                             (mode === 'local') ? 'Service: Local only' :
                             'Service: Overnight';
  // Visual highlight for overnight service window
  serviceState.classList.toggle('late-night', mode === 'overnight');
}

function iconFor(serviceId, isExpress) {
  const meta = SERVICE_META[serviceId];
  if (isExpress && meta.expressIcon) return meta.expressIcon;
  return meta.localIcon;
}

function serviceLabel(serviceId, isExpress) {
  return isExpress ? `<${serviceId}>` : `(${serviceId})`;
}

function lineBadgeHtml(serviceId, isExpress) {
  const src = iconFor(serviceId, isExpress);
  return `<img src="${src}" alt="${serviceId} ${isExpress?'Express':'Local'}" style="width:22px;height:22px;border-radius:6px;object-fit:contain;"/>`;
}

function slideDown(el) {
  el.classList.add('open');
  el.style.maxHeight = el.scrollHeight + 'px';
  el.style.opacity = '1';
}

function renderArrivals() {
  const now = new Date();
  const station = stationSelect.value;
  const limit = Number(limitSelect.value || 8);
  const rows = arrivalsForStation(station, now).slice(0, limit);

  const nowSeconds = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();

  arrivalsEl.innerHTML = rows.map((r, idx) => {
    const trainSeed = `${r.serviceId}-${r.tag}-${r.departureMin}-${r.origin}-${r.destination}`;
    const consist = getTrainConsist(trainSeed, r.serviceId, r.isExpress);

    // Single-train shuttles have fixed consists + fixed lead cars by direction.
    if (SINGLE_TRAIN_SHUTTLES.has(r.serviceId)) {
      consist.model = 'MTC-T 110';
      consist.cars = 2;
      const fixed = FIXED_SHUTTLE_LEAD_CARS[r.serviceId] && FIXED_SHUTTLE_LEAD_CARS[r.serviceId][r.destination];
      if (typeof fixed === 'number') consist.leadCar = fixed;
    }

    // Detailed stop times / position
    const stopTimes = calculateStopTimes(trainSeed, r.stops, r.departureMin, r.segmentTimes);
    const pos = getTrainPosition(stopTimes, nowSeconds);

    // Decide pill time label
    const minsText = (r.minsAway <= 0) ? 'Now' : `${Math.round(r.minsAway)} min`;

    const trainId = `${r.serviceId}-${r.tag}-${r.departureMin}-${idx}`.replace(/[^a-zA-Z0-9_-]/g,'');
    const isOpen = openDetails.has(trainId);
    const isExpanded = expandedStops.has(trainId);

    // Stop list HTML (full view)
    const stopsHtml = stopTimes.stops.map((st, i) => {
      let cls = 'stop-item';
      let icon = ICONS.pinGray;

      if (pos.status === 'at-station' && pos.currentIndex === i) {
        cls += ' current' + (st.isDelayed ? ' delayed' : '');
        icon = st.isDelayed ? ICONS.pinOrange : ICONS.pinGreen;
      } else if (pos.status === 'en-route' && i === pos.toIndex) {
        cls += ' en-route';
        icon = ICONS.pinDim;
      } else if ((pos.status === 'at-station' && i < pos.currentIndex) ||
                 (pos.status === 'en-route' && i < pos.fromIndex)) {
        cls += ' past';
        icon = ICONS.pinDim;
      }

      const sched = formatTime24Full(st.scheduledArrivalSec);
      const actual = formatTime24Full(st.actualArrivalSec);
      const delayed = st.isDelayed && (actual !== sched);

      const timeHtml = delayed
        ? `<span class="scheduled">${sched}</span><span class="new-time">${actual}</span>`
        : `<span>${actual}</span>`;

      return `<li class="${cls}">
        <span class="stop-icon">${icon}</span>
        <div class="stop-time-main ${delayed ? 'delayed' : ''}">${timeHtml}</div>
        <div class="stop-name">${st.name}</div>
        <div class="stop-details">
          <span class="detail-item">${ICONS.clock}<span>${st.isDelayed ? `Delayed ${Math.round(st.delaySeconds/60)}m` : 'On time'}</span></span>
        </div>
      </li>`;
    }).join('');

    // Compact view: show only origin + destination + current status
    const originStop = stopTimes.stops[0];
    const destStop = stopTimes.stops[stopTimes.stops.length - 1];

    let statusBanner = '';
    if (pos.status === 'at-station') {
      statusBanner = `<div class="en-route-banner">${ICONS.clock} At ${pos.currentStop}${pos.isDelayed ? ' (delayed)' : ''}</div>`;
    } else if (pos.status === 'en-route') {
      statusBanner = `<div class="en-route-banner">${ICONS.clock} En route: ${pos.fromStop} → ${pos.toStop}</div>`;
    } else if (pos.status === 'not-started') {
      statusBanner = `<div class="en-route-banner">${ICONS.clock} Not started yet</div>`;
    }

    const badge = lineBadgeHtml(r.serviceId, r.isExpress);
    const label = serviceLabel(r.serviceId, r.isExpress);

    return `<details class="row" data-train-id="${trainId}" ${isOpen ? 'open' : ''}>
      <summary style="list-style:none; cursor:pointer;">
  <div>
    <div class="lineTag" style="display:flex; align-items:center; gap:8px;">
      ${badge} <span>Line</span>
    </div>
    <div class="dest">to ${r.destination}</div>
  </div>
  <div class="mins">${minsText}</div>
</summary>

      <div style="margin-top:10px;">
        <div class="train-info-box">
          <div class="train-info-header">
            <span class="route-code">${r.tag}</span>
            <span>${r.origin} to ${r.destination}</span>
          </div>
          <div class="train-info-details">
            <span class="model">${consist.model}</span>
            <span>with ${consist.cars} Cars</span>
            <span class="lead-car">Lead Car: ${consist.leadCar}</span>
          </div>
        </div>

        ${statusBanner}

        <div class="compact-view" id="compact-${trainId}" style="${isExpanded ? 'display:none;' : ''}">
          <div class="compact-stop ${pos.status==='not-started'?'at-station':''}">
            <div class="compact-time"><span class="scheduled">${formatTime24Full(originStop.actualArrivalSec)}</span></div>
            <div class="compact-icon">${ICONS.pinDim}</div>
            <div class="compact-name">${originStop.name}</div>
          </div>
          <button class="mid-stops-btn" data-action="expand" data-train-id="${trainId}">
            Show all stops
          </button>
          <div class="compact-stop">
            <div class="compact-time"><span class="scheduled">${formatTime24Full(destStop.actualArrivalSec)}</span></div>
            <div class="compact-icon">${ICONS.pinDim}</div>
            <div class="compact-name">${destStop.name}</div>
          </div>
        </div>

        <div class="slide" id="full-${trainId}" style="${isExpanded ? 'display:block; max-height:none; opacity:1;' : 'display:none;'}">
          <div class="subtle" style="margin-bottom:8px;">Making stops at…</div>
          <ul class="stops-list">${stopsHtml}</ul>
        </div>
      </div>
    </details>`;
  }).join('') || `<div class="subtle">No upcoming trains in the next 6 hours.</div>`;

  wireUpEventListeners();
}

function wireUpEventListeners() {
  arrivalsEl.querySelectorAll('details.row').forEach(d => {
    const trainId = d.dataset.trainId;
    d.addEventListener('toggle', () => {
      if (d.open) {
        openDetails.add(trainId);
      } else {
        openDetails.delete(trainId);
        expandedStops.delete(trainId);
        const compact = d.querySelector(`#compact-${trainId}`);
        const full = d.querySelector(`#full-${trainId}`);
        if (compact) compact.style.display = '';
        if (full) {
          full.style.display = 'none';
          full.classList.remove('open');
          full.style.maxHeight = '0px';
        }
      }
    });
  });

  arrivalsEl.querySelectorAll('[data-action="expand"]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const trainId = btn.dataset.trainId;
      const compact = document.getElementById(`compact-${trainId}`);
      const full = document.getElementById(`full-${trainId}`);
      if (compact && full) {
        compact.style.display = 'none';
        full.style.display = 'block';
        full.style.maxHeight = '0px';
        full.style.opacity = '0';
        requestAnimationFrame(() => slideDown(full));
        expandedStops.add(trainId);
      }
    });
  });
}

renderStations();
renderClock();
renderArrivals();

setInterval(() => {
  renderClock();
  renderArrivals();
}, 5000);

stationSelect.addEventListener('change', () => {
  openDetails.clear();
  expandedStops.clear();
  renderArrivals();
});
limitSelect.addEventListener('change', renderArrivals);
refreshBtn.addEventListener('click', () => { renderClock(); renderArrivals(); });

// ---------------------------
// OPTIONAL: basic offline cache
// ---------------------------
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    const sw = URL.createObjectURL(new Blob([
      `self.addEventListener('install', e=>{ e.waitUntil(caches.open('borail-v1').then(c=>c.addAll(['./']))); });` +
      `self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=>r || fetch(e.request))); });`
    ], { type: 'text/javascript' }));
    navigator.serviceWorker.register(sw).catch(() => {});
  });
}
  </script>
</body>
</html>
