<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BORail Live Timetable</title>
  <!-- iOS add-to-home support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="BORail" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Crect width='100%25' height='100%25' fill='%230a0a0a'/%3E%3Ccircle cx='90' cy='90' r='70' fill='%23ff3b30'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-family='Arial' font-size='64' fill='white'%3EB%3C/text%3E%3C/svg%3E" />
  <style>
    :root {
      --bg: #0b0b10;
      --card: #141421;
      --muted: #a0a3ad;
      --text: #f3f4f8;
      --accent: #8a8fff;
      --success: #3ddc84;
      --danger: #ff5a5f;
      --line-Red: #ff3b30;
      --line-Gold: #ffcc00;
      --line-Green: #34c759;
      --line-Orange: #ff9500;
      --line-Blue: #007aff;
      --line-Pink: #ff2d55;
      --line-Brown: #a2845e;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
        margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Inter, Helvetica, Arial, sans-serif;
        background: radial-gradient(1200px 600px at 50% -200px, #151528, #0a0a12) fixed;
        color: var(--text);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        /* space for fixed tab bar */
        padding-bottom: calc(78px + env(safe-area-inset-bottom));
}
    header {
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: saturate(180%) blur(14px);
      background: rgba(10,10,18,.65);
      border-bottom: 1px solid rgba(255,255,255,.08);
      padding-top: env(safe-area-inset-top); /* ✅ NEW LINE */
    }
    .wrap { max-width: 860px; margin: 0 auto; padding: 12px 16px; }
    .title { font-weight: 800; letter-spacing: .2px; font-size: 22px; }
    .subtle { color: var(--muted); font-size: 12px; }

    .controls { display: grid; gap: 10px; grid-template-columns: 1fr auto; align-items: center; margin-top: 10px; }
    select, button, input[type="time"] {
      width: 100%; appearance: none; border: 1px solid rgba(255,255,255,.12); background: var(--card);
      color: var(--text); border-radius: 14px; padding: 12px 40px 12px 12px; font-size: 16px;
    }
    .seg { display: flex; gap: 10px; align-items: center; }
    .pill { padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); font-size: 12px; }
    .pill.late-night {
  border-color: var(--line-Gold);
  color: var(--line-Gold);
  box-shadow: 0 0 0 2px rgba(255, 204, 0, 0.20) inset; /* subtle highlight */
}

    .grid { display: grid; gap: 12px; margin-top: 14px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.03), transparent), var(--card); border: 5px solid rgba(255,255,255,.06); border-radius: 18px; padding: 14px; }

    .list { display: grid; gap: 15px; }
    .row { display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center; padding: 18px 15px; border-radius: 14px; border: 1px solid rgba(255,255,255,.06); background: rgba(255,255,255,.02); }
    .dot { width: 14px; height: 14px; border-radius: 50%; box-shadow: 0 0 0 3px rgba(255,255,255,.08) inset; }
    .lineTag { font-weight: 560; letter-spacing: .3px; }
    .dest { color: var(--muted); font-size: 13px; }
    .mins { font-weight: 700; font-variant-numeric: tabular-nums; }

    .banner { display:flex; align-items:center; justify-content:space-between; gap: 10px; padding: 12px; border:1px dashed rgba(255,255,255,.10); border-radius:14px; background: rgba(255,255,255,.03); }
    .adbox { height: 64px; border-radius: 12px; background: linear-gradient(90deg, rgba(255,255,255,.06), transparent), #0b0b10; border:1px solid rgba(255,255,255,.08); flex:1; display:flex; align-items:center; justify-content:center; color: var(--muted); font-size:12px; }

    footer { color: var(--muted); font-size: 12px; padding: 40px 0 80px; text-align: center; }

    @media (min-width: 700px) { .grid { grid-template-columns: 2fr 1fr; } }

    /* Route stops list: pin icons + connecting line */
.stops { 
  list-style: none; 
  margin: 0; 
  padding-left: 0; 
  line-height: 1.6;
  color: #fff; /* text + pin always white */
}
.stops li {
  position: relative;
  margin: 6px 0 10px 0;
  padding-left: 28px; /* room for pin */
}
/* the pin */
.stops li::before {
  content: "";
  position: absolute;
  left: 2px;
  top: 2px;
  width: 18px;
  height: 18px;
  background: no-repeat center / contain
    url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M12 22s-7-4.5-7-11a7 7 0 1 1 14 0c0 6.5-7 11-7 11z' fill='none' stroke='white' stroke-width='2'/><circle cx='12' cy='11' r='2.5' fill='white'/></svg>");
}
/* the vertical connecting line (hidden on the last item) */
.stops li::after {
  content: "";
  position: absolute;
  left: 10px;          /* centers under the pin */
  top: 22px;           /* start just below the pin */
  bottom: -8px;        /* extend a bit below the item */
  width: 2px;
  background: rgba(255,255,255,0.14);
}
.stops li:last-child::after { display: none; }

.linklike { 
  background: none; border: 0; padding: 0; 
  color: var(--accent); font: inherit; cursor: pointer;
}

/* Slide animation for the full stop list */
.slide {
  overflow: hidden;
  max-height: 0;         /* collapsed */
  opacity: 0;
  transition: max-height 320ms ease, opacity 220ms ease;
}
.slide.open {
  opacity: 1;
}

/* --- Bottom tab bar (iOS style) --- */
.tabbar {
  position: fixed;
  left: 0; right: 0; bottom: 0;
  z-index: 20;
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  align-items: end;
  gap: 6px;
  padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
  border-top: 1px solid rgba(255,255,255,.08);
  background: rgba(180,180,180,0.20); /* ✅ grayish background */
  backdrop-filter: saturate(180%) blur(14px);
}

.tabbar a {
  text-decoration: none;
  color: var(--muted);
  text-align: center;
}

.tabbar .item {
  display: grid;
  gap: 6px;
  justify-items: center;
  font-size: 12px;
}

.tabbar .item img {
  width: 26px; height: 26px;
  display: block;
  opacity: .8;
  filter: grayscale(100%);
}

.tabbar a.active {
  color: var(--accent);
}

.tabbar a.active img {
  opacity: 1;
  filter: none;
}

  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">BORail Live Timetable</div>
      <div class="subtle" id="nowText">—</div>
      <div class="controls">
        <select id="stationSelect" aria-label="Choose station"></select>
        <div class="seg">
          <span class="pill" id="serviceState">Service: Normal</span>
          <button id="refreshBtn" title="Refresh">↻</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <div class="card">
        <div class="banner" style="margin-bottom:12px;">
          <div>Upcoming trains</div>
          <div class="seg">
            <label class="subtle" for="limitSelect">Show</label>
            <select id="limitSelect">
              <option value="5">5</option>
              <option value="8">8</option>
              <option value="12">12</option>
            </select>
          </div>
        </div>
        <div id="arrivals" class="list"></div>
      </div>

      <aside class="card">
        <div class="banner" style="margin-bottom:12px;">
          <div class="subtle">Sponsored</div>
          <div class="pill">Ad</div>
        </div>
        <div class="adbox">
  <img src="ad2.png" alt="Advertisement" style="max-width:100%; max-height:64px; border-radius:10px;">
</div>
        <div style="height:10px"></div>
        <div class="adbox">
  <a href="https://youtube.com/theemfanner" target="_blank" rel="noopener">
    <img src="ad1.png" alt="Promote YouTube Channel" style="max-width:100%; max-height:64px; border-radius:10px;">
  </a>
</div>
      </aside>
    </section>

    <section class="card" style="margin-top:12px;">
      <details>
        <summary class="subtle">About this app</summary>
        <p style="color:var(--muted); line-height:1.5">This is a fictional live timetable for a Minecraft metro with 62 stations across seven lines: Red, Gold, Green, Orange, Blue, Pink, and Brown. Times are computed on-device from the current time and line schedules. Add this site to your iPhone Home Screen to use it like a native app.</p>
      </details>
    </section>
  </main>

  <footer>© BORail • Built for iPhone • Works offline after first load</footer>
  
  <nav class="tabbar" role="navigation" aria-label="Primary">
  <!-- Timetable (current page) -->
  <a class="active" href="index.html">
    <div class="item">
      <img src="timetableicon.png" alt="" width="26" height="26" />
      <span>Timetable</span>
    </div>
  </a>

  <!-- Map -->
  <a href="map.html">
    <div class="item">
      <img src="map%20icon.png" alt="" width="26" height="26" />
      <span>Map</span>
    </div>
  </a>

  <!-- Status (placeholder for now) -->
  <a href="#">
    <div class="item">
      <img src="statusicon.png" alt="" width="26" height="26" />
      <span>Status</span>
    </div>
  </a>
</nav>

  <script>
      let ORANGE_ENABLED = false; // flip to true to enable the Orange Line event shuttle
  // ---------------------------
  // 1) DATA MODEL (edit here)
  // ---------------------------
  // Minimal sample network shown; extend to all 62 stations.
  // Strategy: define stations once, each line's ordered route, segment times, and service patterns.
  const STATIONS = [
    { id: 'Alpherst', name: 'Alpherst' },
    { id: 'Ameryville', name: 'Ameryville' },
    { id: 'Atkins Bridge', name: 'Atkins Bridge' },
    { id: 'Atkinson Junction', name: 'Atkinson Junction' },
    { id: 'Bayview Park', name: 'Bayview Park' },
    { id: 'Berwick Hall', name: 'Berwick Hall' },
    { id: 'Boylston', name: 'Boylston' },
    { id: 'Bradford Bay', name: 'Bradford Bay' },
    { id: 'Bradford Square', name: 'Bradford Square' },
    { id: 'Brandywine', name: 'Brandywine' },
    { id: 'Brookfield Lawn', name: 'Brookfield Lawn' },
    { id: 'Burlington - University of NCU', name: 'Burlington - University of NCU' },
    { id: 'Cambridge Central', name: 'Cambridge Central' },
    { id: 'Cannon View', name: 'Cannon View' },
    { id: 'Carrollton', name: 'Carrollton' },
    { id: 'Chelsea Bay', name: 'Chelsea Bay' },
    { id: 'Cherrywood', name: 'Cherrywood' },
    { id: 'Doverville', name: 'Doverville' },
    { id: 'East Heights', name: 'East Heights' },
    { id: 'Foxston', name: 'Foxston' },
    { id: 'Garner', name: 'Garner' },
    { id: 'Grant Park', name: 'Grant Park' },
    { id: 'Greens Corner', name: 'Greens Corner' },
    { id: 'Groveton', name: 'Groveton' },
    { id: 'Hadleigh', name: 'Hadleigh' },
    { id: 'Harrington City', name: 'Harrington City' },
    { id: 'Hoganville', name: 'Hoganville' },
    { id: 'Hutchinson Point', name: 'Hutchinson Point' },
    { id: 'Kenilworth', name: 'Kenilworth' },
    { id: 'La Vista', name: 'La Vista' },
    { id: 'Leighton Castle', name: 'Leighton Castle' },
    { id: 'Madisonboro', name: 'Madisonboro' },
    { id: 'Millford Heights', name: 'Millford Heights' },
    { id: 'Mount Hindsboro', name: 'Mount Hindsboro' },
    { id: 'Mount River', name: 'Mount River' },
    { id: 'New Cottage', name: 'New Cottage' },
    { id: 'New Halifax', name: 'New Halifax' },
    { id: 'New Salemview', name: 'New Salemview' },
    { id: 'Newkirk', name: 'Newkirk' },
    { id: 'Newkirk - Oak Street', name: 'Newkirk - Oak Street' },
    { id: 'Oakville City Center', name: 'Oakville City Center' },
    { id: 'Oakville Exchange', name: 'Oakville Exchange' },
    { id: 'Oakville Plaza', name: 'Oakville Plaza' },
    { id: 'Orchard Ridge', name: 'Orchard Ridge' },
    { id: 'Perry Road', name: 'Perry Road' },
    { id: 'Port Williamson', name: 'Port Williamson' },
    { id: 'Radcliff Fields', name: 'Radcliff Fields' },
    { id: 'Rockcastle', name: 'Rockcastle' },
    { id: 'Roxbury Landing', name: 'Roxbury Landing' },
    { id: 'Santa Mora', name: 'Santa Mora' },
    { id: 'Scottsbury', name: 'Scottsbury' },
    { id: 'Scottsdale', name: 'Scottsdale' },
    { id: 'South Harrington', name: 'South Harrington' },
    { id: 'Talmedge Hill', name: 'Talmedge Hill' },
    { id: 'Tyford Farms', name: 'Tyford Farms' },
    { id: 'Vanwood', name: 'Vanwood' },
    { id: 'Veridia Nexus', name: 'Veridia Nexus' },
    { id: 'Westpoint', name: 'Westpoint' },
    { id: 'Whitebranch', name: 'Whitebranch' },
    { id: 'Willow Springs', name: 'Willow Springs' },
    { id: 'Wood-By-Hike', name: 'Wood-By-Hike' },
    { id: 'Oakville City Airport', name: 'Oakville City Airport' }
  ];

  // Helper to build uniform 3-min segments for any route
  const segFor = (route, mins=3) => Array(route.length-1).fill(mins);

  // ---------------------------
  // ROUTE VARIANTS (with codes)
  // bidirectional=true means we can run this code both ways (reverse the route for the opposite direction)
  // Brown Line is special: RW01N and RW01S are direction-specific.
  // ---------------------------
  const ROUTE_VARIANTS = [
    // GREEN
    { line: 'Green', color: '#34c759', code: 'RG01', bidirectional: true, route: ['Mount River','Talmedge Hill','Oakville Plaza','Oakville Exchange','Oakville City Airport','Atkins Bridge','Cannon View','Rockcastle','Willow Springs','Port Williamson'] },
    { line: 'Green', color: '#34c759', code: 'RG02', bidirectional: true, route: ['Mount River','Talmedge Hill','Oakville Plaza','Oakville Exchange','Oakville City Airport','Atkins Bridge','Cannon View','Rockcastle','Willow Springs','Newkirk'] },
    { line: 'Green', color: '#34c759', code: 'RG03', bidirectional: true, route: ['Mount River','Talmedge Hill','Oakville Plaza','Oakville Exchange','Oakville City Airport','Radcliff Fields','Atkins Bridge','Cannon View','Rockcastle','Willow Springs','Burlington - University of NCU','Newkirk'] },

    // RED
    { line: 'Red', color: '#ff3b30', code: 'RR05', bidirectional: true, route: ['Newkirk','Newkirk - Oak Street','Hoganville','Bayview Park','Chelsea Bay','Berwick Hall','Cambridge Central','Atkinson Junction','La Vista','Brookfield Lawn','Boylston'] },
    { line: 'Red', color: '#ff3b30', code: 'RR04', bidirectional: true, route: ['Newkirk','Hoganville','Chelsea Bay','Berwick Hall','Cambridge Central','Atkinson Junction','La Vista','Brookfield Lawn','Boylston'] },
    { line: 'Red', color: '#ff3b30', code: 'RR03', bidirectional: true, route: ['Newkirk','Newkirk - Oak Street','Hoganville','Bayview Park','Chelsea Bay','Berwick Hall','Cambridge Central','Atkinson Junction','La Vista','Brookfield Lawn','Foxston','New Cottage','Whitebranch'] },
    { line: 'Red', color: '#ff3b30', code: 'RR02', bidirectional: true, route: ['Newkirk','Berwick Hall','Cambridge Central','Atkinson Junction','La Vista','Brookfield Lawn','Foxston','New Cottage','Whitebranch'] },
    { line: 'Red', color: '#ff3b30', code: 'RR01', bidirectional: true, route: ['Newkirk','Hoganville','Berwick Hall','Atkinson Junction','Garner','Kenilworth'] },

    // GOLD (only RG01)
    { line: 'Gold', color: '#ffcc00', code: 'RG01', bidirectional: true, route: ['Berwick Hall','Westpoint','Bradford Square','Bradford Bay'] },

    // ORANGE (only RO01)
    { line: 'Orange', color: '#ff9500', code: 'RO01', bidirectional: true, route: ['Oakville City Airport','Veridia Nexus'] },

    // BLUE
    { line: 'Blue', color: '#007aff', code: 'RB01', bidirectional: true, route: ['Oakville Plaza','Oakville City Center','Oakville Exchange','Perry Road','Mount Hindsboro','Greens Corner','Doverville','Orchard Ridge','Groveton','Madisonboro','Hutchinson Point','Vanwood','South Harrington','Harrington City','Carrollton','Hadleigh'] },
    { line: 'Blue', color: '#007aff', code: 'RB02', bidirectional: true, route: ['Oakville Plaza','Oakville City Center','Oakville Exchange','Greens Corner','Doverville','Orchard Ridge','Groveton','Madisonboro','Hutchinson Point','Vanwood','South Harrington','Harrington City','Carrollton','Hadleigh'] },
    { line: 'Blue', color: '#007aff', code: 'RB03', bidirectional: true, route: ['Oakville Plaza','Oakville City Center','Oakville Exchange','Perry Road','Mount Hindsboro','Greens Corner','Doverville','Orchard Ridge','Groveton','Madisonboro','Hutchinson Point','Vanwood','South Harrington','Harrington City'] },

    // PINK
    { line: 'Pink', color: '#ff2d55', code: 'RP01', bidirectional: true, route: ['Leighton Castle','Oakville Plaza','Oakville City Center','Oakville Exchange','Perry Road','Mount Hindsboro','Wood-By-Hike','New Salemview','Millford Heights','Roxbury Landing','East Heights'] },
    { line: 'Pink', color: '#ff2d55', code: 'RP02', bidirectional: true, route: ['Oakville City Airport','Perry Road','Mount Hindsboro','Wood-By-Hike','New Salemview','Millford Heights','Roxbury Landing','East Heights'] },

    // BROWN (direction-specific)
    { line: 'Brown', color: '#a2845e', code: 'RW01N', bidirectional: false, route: ['East Heights','Alpherst','New Halifax','Tyford Farms','Scottsbury','Ameryville','Scottsdale','Grant Park','Cherrywood','Brandywine','Santa Mora'] },
    { line: 'Brown', color: '#a2845e', code: 'RW01S', bidirectional: false, route: ['Santa Mora','Brandywine','Cherrywood','Grant Park','Scottsdale','Ameryville','Scottsbury','Tyford Farms','New Halifax','Alpherst','Roxbury Landing','East Heights'] }
  ];

  // ---------------------------
  // PER-LINE SERVICE WINDOWS (unchanged from earlier where applicable)
  // ---------------------------
  const LINE_SERVICE = {
    'Green': {
      weekday: [ { start: '05:00', end: '23:00', every: 10 } ],
      weekend: [ { start: '06:00', end: '22:00', every: 12 } ]
    },
    'Red': {
      weekday: [
        { start: '05:00', end: '06:59', every: 10 },
        { start: '07:00', end: '09:59', every: 5 },
        { start: '10:00', end: '15:59', every: 7 },
        { start: '16:00', end: '18:59', every: 5 },
        { start: '19:00', end: '23:30', every: 10 },
      ],
      weekend: [ { start: '06:00', end: '23:30', every: 10 } ]
    },
    'Gold': { weekday: [], weekend: [] },
    'Orange': { weekday: [], weekend: [] },
    'Blue': {
      weekday: [
        { start: '05:00', end: '06:59', every: 10 },
        { start: '07:00', end: '09:59', every: 6 },
        { start: '10:00', end: '15:59', every: 8 },
        { start: '16:00', end: '18:59', every: 6 },
        { start: '19:00', end: '23:30', every: 10 },
      ],
      weekend: [ { start: '06:00', end: '23:30', every: 10 } ]
    },
    'Pink': {
      weekday: [ { start: '05:30', end: '22:30', every: 8 } ],
      weekend: [ { start: '06:00', end: '22:00', every: 10 } ]
    },
    'Brown': {
      weekday: [ { start: '05:00', end: '23:30', every: 10 } ],
      weekend: [ { start: '06:00', end: '22:30', every: 12 } ]
    }
  };

  // ---------------------------
  // TERMINAL-ONLY DESTINATION RULES (from your previous step)
  // ---------------------------
  const TERMINAL_RULES = {
    'Mount River': ['Port Williamson', 'Newkirk'],
    'Leighton Castle': ['East Heights'],
    'Oakville Plaza': ['Harrington City', 'Hadleigh', 'Port Williamson', 'Newkirk', 'Mount River', 'East Heights', 'Leighton Castle'],
    'East Heights': ['Leighton Castle', 'Santa Mora'],
    'Santa Mora': ['East Heights'],
    'Harrington City': ['Oakville Plaza'],
    'Hadleigh': ['Oakville Plaza'],
    'Oakville City Airport': ['East Heights', 'Veridia Nexus', 'Port Williamson', 'Newkirk', 'Mount River'],
    'Port Williamson': ['Mount River'],
    'Newkirk': ['Mount River', 'Kenilworth', 'Boylston', 'Whitebranch'],
    'Berwick Hall': ['Bradford Bay', 'Boylston', 'Newkirk', 'Whitebranch', 'Kenilworth'],
    'Bradford Bay': ['Berwick Hall'],
    'Kenilworth': ['Newkirk'],
    'Boylston': ['Newkirk'],
    'Whitebranch': ['Newkirk'],
    'Veridia Nexus': ['Oakville City Airport']
  };

  // ---------------------------
  // 2) ENGINE
  // ---------------------------
  const isWeekend = d => (d.getDay()===0 || d.getDay()===6);
  const toMin = t => { const [h,m]=t.split(':').map(Number); return h*60+m; };
  const expandDepartures = periods => {
    const out=[]; periods.forEach(p=>{ let cur=toMin(p.start), end=toMin(p.end); while(cur<=end){ out.push(cur); cur+=p.every; } }); return out;
  };
  const cumulative = (seg,i)=>{ let s=0; for(let k=0;k<i;k++) s+=seg[k]; return s; };

  // Deterministic picker so a given (line+minute) always maps to the same variant this session
  function pickVariant(lineName, minuteValue){
    const list = ROUTE_VARIANTS.filter(v=>v.line===lineName);
    if (!list.length) return null;
    // FNV-1a like hash → index
    let h = 2166136261 >>> 0;
    const s = `${lineName}:${minuteValue}`;
    for (let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
    const idx = h % list.length;
    return list[idx];
  }
  
  // Custom Gold Line shuttle definition
const GOLD_ROUTE = ['Berwick Hall','Westpoint','Bradford Square','Bradford Bay'];
// forward segment times (minutes)
const GOLD_FORWARD = [1.5, 1.5, 2];   // BH→W =1.5, W→BSq=1.5, BSq→BBay=2
// reverse segment times (minutes)
const GOLD_REVERSE = [2, 1.5, 2.5];   // BBay→BSq=2, BSq→W=1.5, W→BH=2.5

function goldShuttleTrips(now=new Date()){
  const trips = [];
  const startMin = 5*60;   // 05:00
  const endMin = 23*60;    // 23:00
  let t = startMin;
  let dir = 'forward';

  while (t <= endMin){
    if (dir === 'forward'){
      let cur = t;
      // through forward route
      for (let i=0;i<GOLD_ROUTE.length;i++){
        trips.push({ station:GOLD_ROUTE[i], time:cur, dest:'Bradford Bay', line:'Gold', code:'RG01', color:'#ffcc00', stops:GOLD_ROUTE });
        if (i < GOLD_FORWARD.length) cur += GOLD_FORWARD[i];
      }
      // dwell 3 min at Bradford Bay
      t = cur + 3;
      dir = 'reverse';
    } else {
      let cur = t;
      // through reverse route
      for (let i=GOLD_ROUTE.length-1;i>=0;i--){
        trips.push({ station:GOLD_ROUTE[i], time:cur, dest:'Berwick Hall', line:'Gold', code:'RG01', color:'#ffcc00', stops:[...GOLD_ROUTE].reverse() });
        if (i > 0) cur += GOLD_REVERSE[GOLD_ROUTE.length-1 - i];
      }
      // dwell 5 min at Berwick Hall
      t = cur + 5;
      dir = 'forward';
    }
  }
  return trips;
}

// Custom Orange Line shuttle definition (event-only)
const ORANGE_ROUTE = ['Oakville City Airport','Veridia Nexus'];
// forward segment times (minutes)
const ORANGE_FORWARD = [3];   // Airport → Veridia Nexus = 3
// reverse segment times (minutes)
const ORANGE_REVERSE = [3];   // Veridia Nexus → Airport = 3

function orangeShuttleTrips(now=new Date()){
  const trips = [];
  if (!ORANGE_ENABLED) return trips;  // disabled unless flag is true

  const startMin = 5*60;   // 05:00
  const endMin = 23*60;    // 23:00
  let t = startMin;
  let dir = 'forward';

  while (t <= endMin){
    if (dir === 'forward'){
      let cur = t;
      // Airport to Veridia Nexus
      trips.push({ station: ORANGE_ROUTE[0], time: cur, dest: 'Veridia Nexus', line:'Orange', code:'RO01', color:'#ff9500', stops: ORANGE_ROUTE });
      cur += ORANGE_FORWARD[0];
      trips.push({ station: ORANGE_ROUTE[1], time: cur, dest: 'Veridia Nexus', line:'Orange', code:'RO01', color:'#ff9500', stops: ORANGE_ROUTE });
      // dwell 1.5 min at Veridia
      t = cur + 1.5;
      dir = 'reverse';
    } else {
      let cur = t;
      // Veridia Nexus to Airport
      trips.push({ station: ORANGE_ROUTE[1], time: cur, dest: 'Oakville City Airport', line:'Orange', code:'RO01', color:'#ff9500', stops:[...ORANGE_ROUTE].reverse() });
      cur += ORANGE_REVERSE[0];
      trips.push({ station: ORANGE_ROUTE[0], time: cur, dest: 'Oakville City Airport', line:'Orange', code:'RO01', color:'#ff9500', stops:[...ORANGE_ROUTE].reverse() });
      // dwell 5 min at Airport
      t = cur + 5;
      dir = 'forward';
    }
  }
  return trips;
}

  function arrivalsForStation(stationId, now=new Date()){
    const weekend = isWeekend(now);
    const nowMin = now.getHours()*60 + now.getMinutes();
    const results = [];

    const lines = Object.keys(LINE_SERVICE);

    for (const lineName of lines){
      const service = LINE_SERVICE[lineName][weekend?'weekend':'weekday'];
      const dep = expandDepartures(service);

      for (const t0 of dep){
        // Special Brown logic: direction-specific codes
        if (lineName === 'Brown'){
          // Northbound RW01N (East Heights → Santa Mora)
          const vN = ROUTE_VARIANTS.find(v=>v.code==='RW01N');
          const rN = vN.route, segN = segFor(rN);
          const idxN = rN.indexOf(stationId);
          if (idxN !== -1){
            const arr = t0 + cumulative(segN, idxN);
            for (let k=0;k<2;k++){
              const arrDay = arr + k*24*60; const minsAway = arrDay - nowMin;
              if (minsAway >= -1 && minsAway <= 360){
                results.push({ line: vN.line, color: vN.color, code: vN.code,
                  destination: rN[rN.length-1], timeMin: arrDay, minsAway,
                  stops: rN });
              }
            }
          }
          // Southbound RW01S (Santa Mora → East Heights via Roxbury Landing)
          const vS = ROUTE_VARIANTS.find(v=>v.code==='RW01S');
          const rS = vS.route, segS = segFor(rS);
          const idxS = rS.indexOf(stationId);
          if (idxS !== -1){
            const arr = t0 + cumulative(segS, idxS);
            for (let k=0;k<2;k++){
              const arrDay = arr + k*24*60; const minsAway = arrDay - nowMin;
              if (minsAway >= -1 && minsAway <= 360){
                results.push({ line: vS.line, color: vS.color, code: vS.code,
                  destination: rS[rS.length-1], timeMin: arrDay, minsAway,
                  stops: rS });
              }
            }
          }
          continue; // done with Brown for this t0
        }

        // All other lines: pick a variant once per slot, use both directions if bidirectional
        const v = pickVariant(lineName, t0);
        if (!v) continue;
        const r = v.route, seg = segFor(r);

        // forward (as listed)
        const idxF = r.indexOf(stationId);
        if (idxF !== -1){
          const arr = t0 + cumulative(seg, idxF);
          for (let k=0;k<2;k++){
            const arrDay = arr + k*24*60; const minsAway = arrDay - nowMin;
            if (minsAway >= -1 && minsAway <= 360){
              results.push({ line: v.line, color: v.color, code: v.code,
                destination: r[r.length-1], timeMin: arrDay, minsAway,
                stops: r });
            }
          }
        }

        // reverse (only if bidirectional)
        if (v.bidirectional){
          const rRev = [...r].reverse();
          const segRev = segFor(rRev);
          const idxR = rRev.indexOf(stationId);
          if (idxR !== -1){
            const arr = t0 + cumulative(segRev, idxR);
            for (let k=0;k<2;k++){
              const arrDay = arr + k*24*60; const minsAway = arrDay - nowMin;
              if (minsAway >= -1 && minsAway <= 360){
                results.push({ line: v.line, color: v.color, code: v.code,
                  destination: rRev[rRev.length-1], timeMin: arrDay, minsAway,
                  stops: rRev });
              }
            }
          }
        }
      }
    }
    
        // Inject custom Gold Line shuttle
        
            // Inject custom Orange Line shuttle (if enabled)
    if (stationId && ORANGE_ENABLED){
      const orangeTrips = orangeShuttleTrips(now);
      const nowMin = now.getHours()*60 + now.getMinutes();
      for (const g of orangeTrips){
        if (g.station === stationId){
          const minsAway = g.time - nowMin;
          if (minsAway >= -1 && minsAway <= 360){
            results.push({
              line: g.line, color: g.color, code: g.code,
              destination: g.dest, timeMin: g.time, minsAway,
              stops: g.stops
            });
          }
        }
      }
    }
    
    if (stationId){
      const goldTrips = goldShuttleTrips(now);
      const nowMin = now.getHours()*60 + now.getMinutes();
      for (const g of goldTrips){
        if (g.station === stationId){
          const minsAway = g.time - nowMin;
          if (minsAway >= -1 && minsAway <= 360){
            results.push({
              line: g.line, color: g.color, code: g.code,
              destination: g.dest, timeMin: g.time, minsAway,
              stops: g.stops
            });
          }
        }
      }
    }

    // Filter: never show trains whose destination equals the selected station; apply terminal rules if present
    const selectedName = STATIONS.find(s=>s.id===stationId)?.name || stationId;
    let filtered = results.filter(r=> r.destination !== selectedName);
    if (TERMINAL_RULES[selectedName]){
      const allowed = new Set(TERMINAL_RULES[selectedName]);
      filtered = filtered.filter(r=> allowed.has(r.destination));
    }

    filtered.sort((a,b)=> a.timeMin - b.timeMin);
    return filtered;
  }

  // ---------------------------
  // 3) UI BINDINGS
  // ---------------------------
  const stationSelect = document.getElementById('stationSelect');
  const arrivalsEl = document.getElementById('arrivals');
  const nowText = document.getElementById('nowText');
  const limitSelect = document.getElementById('limitSelect');
  const refreshBtn = document.getElementById('refreshBtn');
  const serviceState = document.getElementById('serviceState');

  function fmtMins(mins){ if (mins < -0.5) return 'departed'; if (mins <= 0.5) return 'now'; return `${Math.round(mins)} min`; }
  
  const isLateNight = d => { const h = d.getHours(); return h >= 23 || h < 5; };

  function renderClock(){
  const d = new Date();
  const opts = { hour:'numeric', minute:'2-digit' };
  nowText.textContent = new Intl.DateTimeFormat(undefined, opts).format(d) + ' • Local time';

  // NEW: toggle service pill based on time (11PM–5AM)
  const late = isLateNight(d);
  if (late) {
    serviceState.textContent = 'Service: Late Night';
    serviceState.className = 'pill late-night';
  } else {
    serviceState.textContent = 'Service: Normal';
    serviceState.className = 'pill';
  }
}

  function renderStations(){
    stationSelect.innerHTML = STATIONS.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    const def = STATIONS.find(s=>s.id==='Mount Hindsboro') || STATIONS[0];
    if (def) stationSelect.value = def.id;
  }
  
  // --- slide helpers ---
function slideDown(el){
  // prepare to measure the natural height
  el.classList.add('open');
  el.style.maxHeight = el.scrollHeight + 'px';
  // after the transition ends, let it grow/shrink naturally
  const clear = () => {
    el.style.maxHeight = 'none';
    el.removeEventListener('transitionend', clear);
  };
  el.addEventListener('transitionend', clear);
}

function slideUp(el){
  // lock the current height, then transition to 0
  el.style.maxHeight = el.scrollHeight + 'px';
  requestAnimationFrame(() => {
    el.classList.remove('open');
    el.style.maxHeight = '0px';
  });
}

  function renderArrivals(){
  const sid = stationSelect.value;
  const cap = parseInt(limitSelect.value, 10);
  const list = arrivalsForStation(sid, new Date()).slice(0, cap);

  arrivalsEl.innerHTML = list.map((item, i) => {
    // Build pieces we need for compact + full views
    const stopsHtml = item.stops.map(s=>`<li>${s}</li>`).join('');
    const origin = item.stops[0];
    const dest   = item.stops[item.stops.length - 1];
    const midCount = Math.max(0, item.stops.length - 2);
    const midLabel = `Making ${midCount} ${midCount===1 ? 'stop' : 'stops'}`;

    return `
      <details class="row" data-index="${i}">
        <summary style="list-style:none; display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center; cursor:pointer;">
          <div class="dot" style="background:${item.color}"></div>
          <div>
            <div class="lineTag">${item.line} Line</div>
            <div class="dest">to ${item.destination} <span class="pill" style="margin-left:6px;">${item.code}</span></div>
          </div>
          <div class="mins">${fmtMins(item.minsAway)}</div>
        </summary>

        <!-- Content area: starts compact (origin + mid-count + destination) -->
        <div style="margin:10px 0 2px 26px;">
          <!-- Compact view -->
            <div class="compact" id="compact-${i}">
                <ul class="stops" style="color:#ffffff">
                    <li><strong>${origin}</strong></li>
                </ul>

            <div style="padding-left:1px; margin:1px 0;">
                <button class="linklike" data-action="expand" data-i="${i}">${midLabel}</button>
            </div>

            <ul class="stops" style="color:#ffffff">
                <li><strong>${dest}</strong></li>
            </ul>
            </div>

          <!-- Full list view (hidden until user taps the mid-count text) -->
          <div class="full slide" id="full-${i}">
            <div class="subtle" style="margin-bottom:6px;">Making stops at…</div>
            <ul class="stops" style="color:#ffffff">
              ${stopsHtml}
            </ul>
          </div>
        </div>
      </details>`;
  }).join('') || `<div class="subtle">No upcoming trains in the next 6 hours.</div>`;

  // Wire up expand buttons: switch from compact → full (with slide)
arrivalsEl.querySelectorAll('[data-action="expand"]').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    e.stopPropagation(); // keep the <details> open
    const i = btn.dataset.i;
    const comp = document.getElementById(`compact-${i}`);
    const full = document.getElementById(`full-${i}`);
    if (comp && full){
      comp.style.display = 'none';
      // ensure we're at a known collapsed state
      full.hidden = false;            // ← ADD THIS LINE
      full.style.maxHeight = '0px';
      slideDown(full);
    }
  });
});

  // When the user closes the details, reset to compact view so the mid-count returns
  arrivalsEl.querySelectorAll('details.row').forEach(d=>{
    d.addEventListener('toggle', ()=>{
      if (!d.open){
        const comp = d.querySelector('.compact');
        const full = d.querySelector('.full');
        if (comp && full){ 
            comp.hidden = false; 
            full.hidden = true; 
            comp.style.display = '';
        }
      }
    });
  });
}

  renderStations();
  renderClock();
  renderArrivals();

  setInterval(()=>{ renderClock(); renderArrivals(); }, 20000);
  stationSelect.addEventListener('change', renderArrivals);
  limitSelect.addEventListener('change', renderArrivals);
  refreshBtn.addEventListener('click', ()=>{ renderClock(); renderArrivals(); });

  // ---------------------------
  // 4) OPTIONAL: basic offline cache (works after first load)
  // ---------------------------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      const sw = URL.createObjectURL(new Blob([
        `self.addEventListener('install', e=>{ e.waitUntil(caches.open('borail-v1').then(c=>c.addAll(['./']))); });
`+
        `self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=>r || fetch(e.request))); });`
      ], { type: 'text/javascript' }));
      navigator.serviceWorker.register(sw).catch(()=>{});
    });
  }
  </script>
</body>
</html>
