<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BORail Live Timetable</title>
  <!-- iOS add-to-home support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="BORail" />
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Crect width='100%25' height='100%25' fill='%230a0a0a'/%3E%3Ccircle cx='90' cy='90' r='70' fill='%23ff3b30'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-family='Arial' font-size='64' fill='white'%3EB%3C/text%3E%3C/svg%3E" />
  <style>
    :root {
      --bg: #0b0b10;
      --card: #141421;
      --muted: #a0a3ad;
      --text: #f3f4f8;
      --accent: #8a8fff;
      --success: #3ddc84;
      --danger: #ff5a5f;
      --line-Red: #ff3b30;
      --line-Gold: #ffcc00;
      --line-Green: #34c759;
      --line-Orange: #ff9500;
      --line-Blue: #007aff;
      --line-Pink: #ff2d55;
      --line-Brown: #a2845e;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Inter, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 50% -200px, #151528, #0a0a12) fixed;
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      padding-bottom: env(safe-area-inset-bottom);
    }
    header {
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: saturate(180%) blur(14px);
      background: rgba(10,10,18,.65);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .wrap { max-width: 860px; margin: 0 auto; padding: 12px 16px; }
    .title { font-weight: 800; letter-spacing: .2px; font-size: 22px; }
    .subtle { color: var(--muted); font-size: 12px; }

    .controls { display: grid; gap: 10px; grid-template-columns: 1fr auto; align-items: center; margin-top: 10px; }
    select, button, input[type="time"] {
      width: 100%; appearance: none; border: 1px solid rgba(255,255,255,.12); background: var(--card);
      color: var(--text); border-radius: 14px; padding: 12px 40px 12px 12px; font-size: 16px;
    }
    .seg { display: flex; gap: 10px; align-items: center; }
    .pill { padding: 8px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); font-size: 12px; }

    .grid { display: grid; gap: 12px; margin-top: 14px; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,.03), transparent), var(--card); border: 1px solid rgba(255,255,255,.06); border-radius: 18px; padding: 14px; }

    .list { display: grid; gap: 10px; }
    .row { display: grid; grid-template-columns: auto 1fr auto; gap: 12px; align-items: center; padding: 10px 10px; border-radius: 14px; border: 1px solid rgba(255,255,255,.06); background: rgba(255,255,255,.02); }
    .dot { width: 14px; height: 14px; border-radius: 50%; box-shadow: 0 0 0 3px rgba(255,255,255,.08) inset; }
    .lineTag { font-weight: 700; letter-spacing: .3px; }
    .dest { color: var(--muted); font-size: 13px; }
    .mins { font-weight: 800; font-variant-numeric: tabular-nums; }

    .banner { display:flex; align-items:center; justify-content:space-between; gap: 10px; padding: 12px; border:1px dashed rgba(255,255,255,.10); border-radius:14px; background: rgba(255,255,255,.03); }
    .adbox { height: 64px; border-radius: 12px; background: linear-gradient(90deg, rgba(255,255,255,.06), transparent), #0b0b10; border:1px solid rgba(255,255,255,.08); flex:1; display:flex; align-items:center; justify-content:center; color: var(--muted); font-size:12px; }

    footer { color: var(--muted); font-size: 12px; padding: 40px 0 80px; text-align: center; }

    @media (min-width: 700px) { .grid { grid-template-columns: 2fr 1fr; } }

    .late-night { background: rgba(255, 157, 0, 0.1); border: 1px solid rgba(255, 157, 0, 0.3); }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">BORail Live Timetable</div>
      <div class="subtle" id="nowText">—</div>
      <div class="controls">
        <select id="stationSelect" aria-label="Choose station"></select>
        <div class="seg">
          <span class="pill" id="serviceState">Service: Normal</span>
          <button id="refreshBtn" title="Refresh">↻</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <div class="card">
        <div class="banner" style="margin-bottom:12px;">
          <div>Upcoming trains</div>
          <div class="seg">
            <label class="subtle" for="limitSelect">Show</label>
            <select id="limitSelect">
              <option value="5">5</option>
              <option value="8">8</option>
              <option value="12">12</option>
            </select>
          </div>
        </div>
        <div id="arrivals" class="list"></div>
      </div>

      <aside class="card">
        <div class="banner" style="margin-bottom:12px;">
          <div class="subtle">Sponsored</div>
          <div class="pill">Ad</div>
        </div>
        <div class="adbox">Your ad here • 320×64</div>
        <div style="height:10px"></div>
        <div class="adbox">Promote server • 320×64</div>
      </aside>
    </section>

    <section class="card" style="margin-top:12px;">
      <details>
        <summary class="subtle">About this app</summary>
        <p style="color:var(--muted); line-height:1.5">This is a fictional live timetable for a Minecraft metro with 62 stations across seven lines: Red, Gold, Green, Orange, Blue, Pink, and Brown. Times are computed on-device from the current time and line schedules. Add this site to your iPhone Home Screen to use it like a native app.</p>
      </details>
    </section>
  </main>

  <footer>© BORail • Built for iPhone • Works offline after first load</footer>

  <script>
  // ---------------------------
  // 1) DATA MODEL (edit here)
  // ---------------------------
  // Minimal sample network shown; extend to all 62 stations.
  // Strategy: define stations once, each line's ordered route, segment times, and service patterns.
  const STATIONS = [
    { id: 'Alpherst', name: 'Alpherst' },
    { id: 'Ameryville', name: 'Ameryville' },
    { id: 'Atkins Bridge', name: 'Atkins Bridge' },
    { id: 'Atkinson Junction', name: 'Atkinson Junction' },
    { id: 'Bayview Park', name: 'Bayview Park' },
    { id: 'Berwick Hall', name: 'Berwick Hall' },
    { id: 'Boylston', name: 'Boylston' },
    { id: 'Bradford Bay', name: 'Bradford Bay' },
    { id: 'Bradford Square', name: 'Bradford Square' },
    { id: 'Brandywine', name: 'Brandywine' },
    { id: 'Brookfield Lawn', name: 'Brookfield Lawn' },
    { id: 'Burlington - University of NCU', name: 'Burlington - University of NCU' },
    { id: 'Cambridge Central', name: 'Cambridge Central' },
    { id: 'Cannon View', name: 'Cannon View' },
    { id: 'Carrollton', name: 'Carrollton' },
    { id: 'Chelsea Bay', name: 'Chelsea Bay' },
    { id: 'Doverville', name: 'Doverville' },
    { id: 'East Heights', name: 'East Heights' },
    { id: 'Foxston', name: 'Foxston' },
    { id: 'Garner', name: 'Garner' },
    { id: 'Grant Park', name: 'Grant Park' },
    { id: 'Greens Corner', name: 'Greens Corner' },
    { id: 'Groveton', name: 'Groveton' },
    { id: 'Hadleigh', name: 'Hadleigh' },
    { id: 'Harrington City', name: 'Harrington City' },
    { id: 'Hoganville', name: 'Hoganville' },
    { id: 'Hutchinson Point', name: 'Hutchinson Point' },
    { id: 'Kenilworth', name: 'Kenilworth' },
    { id: 'La Vista', name: 'La Vista' },
    { id: 'Leighton Castle', name: 'Leighton Castle' },
    { id: 'Madisonboro', name: 'Madisonboro' },
    { id: 'Millford Heights', name: 'Millford Heights' },
    { id: 'Mount Hindsboro', name: 'Mount Hindsboro' },
    { id: 'Mount River', name: 'Mount River' },
    { id: 'New Cottage', name: 'New Cottage' },
    { id: 'New Halifax', name: 'New Halifax' },
    { id: 'New Salemview', name: 'New Salemview' },
    { id: 'Newkirk', name: 'Newkirk' },
    { id: 'Newkirk - Oak Street', name: 'Newkirk - Oak Street' },
    { id: 'Oakville City Center', name: 'Oakville City Center' },
    { id: 'Oakville Exchange', name: 'Oakville Exchange' },
    { id: 'Oakville Plaza', name: 'Oakville Plaza' },
    { id: 'Orchard Ridge', name: 'Orchard Ridge' },
    { id: 'Perry Road', name: 'Perry Road' },
    { id: 'Port Williamson', name: 'Port Williamson' },
    { id: 'Radcliff Fields', name: 'Radcliff Fields' },
    { id: 'Rockcastle', name: 'Rockcastle' },
    { id: 'Roxbury Landing', name: 'Roxbury Landing' },
    { id: 'Santa Mora', name: 'Santa Mora' },
    { id: 'Scottsbury', name: 'Scottsbury' },
    { id: 'Scottsdale', name: 'Scottsdale' },
    { id: 'South Harrington', name: 'South Harrington' },
    { id: 'Talmedge Hill', name: 'Talmedge Hill' },
    { id: 'Tyford Farms', name: 'Tyford Farms' },
    { id: 'Vanwood', name: 'Vanwood' },
    { id: 'Veridia Nexus', name: 'Veridia Nexus' },
    { id: 'Westpoint', name: 'Westpoint' },
    { id: 'Whitebranch', name: 'Whitebranch' },
    { id: 'Willow Springs', name: 'Willow Springs' },
    { id: 'Wood-By-Hike', name: 'Wood-By-Hike' },
    { id: 'Wychwood - Oakville City Airport', name: 'Wychwood - Oakville City Airport' }
  ];

  // Late night suspended stations (11PM-5AM)
  const LATE_NIGHT_SUSPENDED = new Set([
    'Port Williamson', 'Radcliff Fields', 'Veridia Nexus', 'Newkirk - Oak Street',
    'Bayview Park', 'Westpoint', 'Bradford Square', 'Bradford Bay', 'Garner',
    'Kenilworth', 'Foxston', 'New Cottage', 'Whitebranch', 'Hutchinson Point',
    'Vanwood', 'South Harrington', 'Harrington City', 'Carrollton', 'Hadleigh',
    // All Brown Line stations
    'Alpherst', 'New Halifax', 'Tyford Farms', 'Scottsbury', 'Ameryville',
    'Scottsdale', 'Grant Park', 'Brandywine', 'Santa Mora'
  ]);

  // Helper to determine if it's late night (11PM-5AM)
  // TESTING: Temporarily set to 9PM-5AM for testing purposes
  const isLateNight = (now = new Date()) => {
    const hour = now.getHours();
    return hour >= 21 || hour < 5; // Changed from 23 to 21 for testing
  };

  // Helper to build uniform 3-min segments for any route
  const segFor = (route, mins=3) => Array(route.length-1).fill(mins);

  // ---------------------------
  // ROUTE VARIANTS (with codes)
  // bidirectional=true means we can run this code both ways (reverse the route for the opposite direction)
  // Brown Line is special: RW01N and RW01S are direction-specific.
  // ---------------------------
  const ROUTE_VARIANTS = [
    // GREEN - Late night: no Port Williamson, no Radcliff Fields
    { line: 'Green', color: '#34c759', code: 'RG01', bidirectional: true, route: ['Mount River','Talmedge Hill','Oakville Plaza','Oakville Exchange','Wychwood - Oakville City Airport','Atkins Bridge','Cannon View','Rockcastle','Willow Springs','Port Williamson'], lateNight: false },
    { line: 'Green', color: '#34c759', code: 'RG01LN', bidirectional: true, route: ['Mount River','Talmedge Hill','Oakville Plaza','Oakville Exchange','Wychwood - Oakville City Airport','Atkins Bridge','Cannon View','Rockcastle','Willow Springs','Newkirk'], lateNight: true },
    { line: 'Green', color: '#34c759', code: 'RG02', bidirectional: true, route: ['Mount River','Talmedge Hill','Oakville Plaza','Oakville Exchange','Wychwood - Oakville City Airport','Atkins Bridge','Cannon View','Rockcastle','Willow Springs','Newkirk'], lateNight: false },
    { line: 'Green', color: '#34c759', code: 'RG03', bidirectional: true, route: ['Mount River','Talmedge Hill','Oakville Plaza','Oakville Exchange','Wychwood - Oakville City Airport','Radcliff Fields','Atkins Bridge','Cannon View','Rockcastle','Willow Springs','Burlington - University of NCU','Newkirk'], lateNight: false },
    { line: 'Green', color: '#34c759', code: 'RG03LN', bidirectional: true, route: ['Mount River','Talmedge Hill','Oakville Plaza','Oakville Exchange','Wychwood - Oakville City Airport','Atkins Bridge','Cannon View','Rockcastle','Willow Springs','Burlington - University of NCU','Newkirk'], lateNight: true },

    // RED - Late night: no suspended stations
    { line: 'Red', color: '#ff3b30', code: 'RR05', bidirectional: true, route: ['Newkirk','Newkirk - Oak Street','Hoganville','Bayview Park','Chelsea Bay','Berwick Hall','Cambridge Central','Atkinson Junction','La Vista','Brookfield Lawn','Boylston'], lateNight: false },
    { line: 'Red', color: '#ff3b30', code: 'RR05LN', bidirectional: true, route: ['Newkirk','Hoganville','Chelsea Bay','Berwick Hall','Cambridge Central','Atkinson Junction','La Vista','Brookfield Lawn','Boylston'], lateNight: true },
    { line: 'Red', color: '#ff3b30', code: 'RR04', bidirectional: true, route: ['Newkirk','Hoganville','Chelsea Bay','Berwick Hall','Cambridge Central','Atkinson Junction','La Vista','Brookfield Lawn','Boylston'], lateNight: false },
    { line: 'Red', color: '#ff3b30', code: 'RR03', bidirectional: true, route: ['Newkirk','Newkirk - Oak Street','Hoganville','Bayview Park','Chelsea Bay','Berwick Hall','Cambridge Central','Atkinson Junction','La Vista','Brookfield Lawn','Foxston','New Cottage','Whitebranch'], lateNight: false },
    { line: 'Red', color: '#ff3b30', code: 'RR03LN', bidirectional: true, route: ['Newkirk','Hoganville','Chelsea Bay','Berwick Hall','Cambridge Central','Atkinson Junction','La Vista','Brookfield Lawn'], lateNight: true },
    { line: 'Red', color: '#ff3b30', code: 'RR02', bidirectional: true, route: ['Newkirk','Berwick Hall','Cambridge Central','Atkinson Junction','La Vista','Brookfield Lawn','Foxston','New Cottage','Whitebranch'], lateNight: false },
    { line: 'Red', color: '#ff3b30', code: 'RR02LN', bidirectional: true, route: ['Newkirk','Berwick Hall','Cambridge Central','Atkinson Junction','La Vista','Brookfield Lawn'], lateNight: true },
    { line: 'Red', color: '#ff3b30', code: 'RR01', bidirectional: true, route: ['Newkirk','Hoganville','Berwick Hall','Atkinson Junction','Garner','Kenilworth'], lateNight: false },
    { line: 'Red', color: '#ff3b30', code: 'RR01LN', bidirectional: true, route: ['Newkirk','Hoganville','Berwick Hall','Atkinson Junction'], lateNight: true },

    // GOLD - No late night service
    { line: 'Gold', color: '#ffcc00', code: 'RG01', bidirectional: true, route: ['Berwick Hall','Westpoint','Bradford Square','Bradford Bay'], lateNight: false },

    // ORANGE - No late night service
    { line: 'Orange', color: '#ff9500', code: 'RO01', bidirectional: true, route: ['Wychwood - Oakville City Airport','Veridia Nexus'], lateNight: false },

    // BLUE - Late night: terminate at Madisonboro
    { line: 'Blue', color: '#007aff', code: 'RB01', bidirectional: true, route: ['Oakville Plaza','Oakville City Center','Oakville Exchange','Perry Road','Mount Hindsboro','Greens Corner','Doverville','Orchard Ridge','Groveton','Madisonboro','Hutchinson Point','Vanwood','South Harrington','Harrington City','Carrollton','Hadleigh'], lateNight: false },
    { line: 'Blue', color: '#007aff', code: 'RB01LN', bidirectional: true, route: ['Oakville Plaza','Oakville City Center','Oakville Exchange','Perry Road','Mount Hindsboro','Greens Corner','Doverville','Orchard Ridge','Groveton','Madisonboro'], lateNight: true },
    { line: 'Blue', color: '#007aff', code: 'RB02', bidirectional: true, route: ['Oakville Plaza','Oakville City Center','Oakville Exchange','Greens Corner','Doverville','Orchard Ridge','Groveton','Madisonboro','Hutchinson Point','Vanwood','South Harrington','Harrington City','Carrollton','Hadleigh'], lateNight: false },
    { line: 'Blue', color: '#007aff', code: 'RB02LN', bidirectional: true, route: ['Oakville Plaza','Oakville City Center','Oakville Exchange','Greens Corner','Doverville','Orchard Ridge','Groveton','Madisonboro'], lateNight: true },
    { line: 'Blue', color: '#007aff', code: 'RB03', bidirectional: true, route: ['Oakville Plaza','Oakville City Center','Oakville Exchange','Perry Road','Mount Hindsboro','Greens Corner','Doverville','Orchard Ridge','Groveton','Madisonboro','Hutchinson Point','Vanwood','South Harrington','Harrington City'], lateNight: false },
    { line: 'Blue', color: '#007aff', code: 'RB03LN', bidirectional: true, route: ['Oakville Plaza','Oakville City Center','Oakville Exchange','Perry Road','Mount Hindsboro','Greens Corner','Doverville','Orchard Ridge','Groveton','Madisonboro'], lateNight: true },

    // PINK - Late night service continues (Roxbury Landing and East Heights served by Pink only)
    { line: 'Pink', color: '#ff2d55', code: 'RP01', bidirectional: true, route: ['Leighton Castle','Oakville Plaza','Oakville City Center','Oakville Exchange','Perry Road','Mount Hindsboro','Wood-By-Hike','New Salemview','Millford Heights','Roxbury Landing','East Heights'], lateNight: false },
    { line: 'Pink', color: '#ff2d55', code: 'RP02', bidirectional: true, route: ['Wychwood - Oakville City Airport','Perry Road','Mount Hindsboro','Wood-By-Hike','New Salemview','Millford Heights','Roxbury Landing','East Heights'], lateNight: false },
    { line: 'Pink', color: '#ff2d55', code: 'RP02LN', bidirectional: true, route: ['Oakville Plaza','Oakville City Center','Oakville Exchange','Perry Road','Mount Hindsboro','Wood-By-Hike','New Salemview','Millford Heights','Roxbury Landing','East Heights'], lateNight: true },

    // BROWN - No late night service (completely suspended)
    { line: 'Brown', color: '#a2845e', code: 'RW01N', bidirectional: false, route: ['East Heights','Alpherst','New Halifax','Tyford Farms','Scottsbury','Ameryville','Scottsdale','Grant Park','Brandywine','Santa Mora'], lateNight: false },
    { line: 'Brown', color: '#a2845e', code: 'RW01S', bidirectional: false, route: ['Santa Mora','Brandywine','Grant Park','Scottsdale','Ameryville','Scottsbury','Tyford Farms','New Halifax','Alpherst','Roxbury Landing','East Heights'], lateNight: false }
  ];

  // ---------------------------
  // PER-LINE SERVICE WINDOWS
  // ---------------------------
  const LINE_SERVICE = {
    'Green': {
      weekday: [ { start: '05:00', end: '23:00', every: 10 } ],
      weekend: [ { start: '06:00', end: '22:00', every: 12 } ],
      lateNight: [ { start: '23:00', end: '04:59', every: 20 } ]
    },
    'Red': {
      weekday: [
        { start: '05:00', end: '06:59', every: 10 },
        { start: '07:00', end: '09:59', every: 5 },
        { start: '10:00', end: '15:59', every: 7 },
        { start: '16:00', end: '18:59', every: 5 },
        { start: '19:00', end: '23:00', every: 10 },
      ],
      weekend: [ { start: '06:00', end: '23:00', every: 10 } ],
      lateNight: [ { start: '23:00', end: '04:59', every: 15 } ]
    },
    'Gold': {
      weekday: [ { start: '05:30', end: '23:00', every: 12 } ],
      weekend: [ { start: '06:00', end: '22:00', every: 12 } ],
      lateNight: [] // No late night service
    },
    'Orange': { 
      weekday: [], 
      weekend: [],
      lateNight: [] // No late night service
    },
    'Blue': {
      weekday: [
        { start: '05:00', end: '06:59', every: 10 },
        { start: '07:00', end: '09:59', every: 6 },
        { start: '10:00', end: '15:59', every: 8 },
        { start: '16:00', end: '18:59', every: 6 },
        { start: '19:00', end: '23:00', every: 10 },
      ],
      weekend: [ { start: '06:00', end: '23:00', every: 10 } ],
      lateNight: [ { start: '23:00', end: '04:59', every: 18 } ]
    },
    'Pink': {
      weekday: [ { start: '05:30', end: '22:30', every: 8 } ],
      weekend: [ { start: '06:00', end: '22:00', every: 10 } ],
      lateNight: [ { start: '23:00', end: '04:59', every: 25 } ]
    },
    'Brown': {
      weekday: [ { start: '05:00', end: '23:00', every: 10 } ],
      weekend: [ { start: '06:00', end: '22:30', every: 12 } ],
      lateNight: [] // No late night service
    }
  };

  // ---------------------------
  // TERMINAL-ONLY DESTINATION RULES
  // ---------------------------
  const TERMINAL_RULES = {
    'Mount River': ['Port Williamson', 'Newkirk'],
    'Leighton Castle': ['East Heights'],
    'Oakville Plaza': ['Harrington City', 'Hadleigh', 'Madisonboro'],
    'East Heights': ['Leighton Castle', 'Santa Mora'],
    'Santa Mora': ['East Heights'],
    'Harrington City': ['Oakville Plaza'],
    'Hadleigh': ['Oakville Plaza'],
    'Madisonboro': ['Oakville Plaza'],
    'Wychwood - Oakville City Airport': ['East Heights', 'Veridia Nexus'],
    'Port Williamson': ['Mount River'],
    'Newkirk': ['Mount River', 'Kenilworth', 'Boylston', 'Whitebranch', 'Atkinson Junction'],
    'Berwick Hall': ['Bradford Bay', 'Atkinson Junction'],
    'Bradford Bay': ['Berwick Hall'],
    'Kenilworth': ['Newkirk'],
    'Boylston': ['Newkirk'],
    'Whitebranch': ['Newkirk'],
    'Atkinson Junction': ['Newkirk', 'Berwick Hall'],
    'Veridia Nexus': ['Wychwood - Oakville City Airport']
  };

  // Late night terminal rules (modified)
  const TERMINAL_RULES_LATE_NIGHT = {
    'Mount River': ['Newkirk'],
    'Leighton Castle': ['East Heights'],
    'Oakville Plaza': ['Madisonboro'],
    'East Heights': ['Leighton Castle'],
    'Madisonboro': ['Oakville Plaza'],
    'Wychwood - Oakville City Airport': ['East Heights'],
    'Newkirk': ['Mount River', 'Boylston', 'Atkinson Junction'],
    'Berwick Hall': ['Atkinson Junction'],
    'Boylston': ['Newkirk'],
    'Atkinson Junction': ['Newkirk', 'Berwick Hall']
  };

  // ---------------------------
  // 2) ENGINE
  // ---------------------------
  const isWeekend = d => (d.getDay()===0 || d.getDay()===6);
  const toMin = t => { const [h,m]=t.split(':').map(Number); return h*60+m; };
  const expandDepartures = periods => {
    const out=[]; periods.forEach(p=>{ let cur=toMin(p.start), end=toMin(p.end); while(cur<=end){ out.push(cur); cur+=p.every; } }); return out;
  };
  const cumulative = (seg,i)=>{ let s=0; for(let k=0;k<i;k++) s+=seg[k]; return s; };

  // Deterministic picker so a given (line+minute) always maps to the same variant this session
  function pickVariant(lineName, minuteValue, lateNightMode = false){
    const list = ROUTE_VARIANTS.filter(v=>v.line===lineName && v.lateNight === lateNightMode);
    if (!list.length) return null;
    // FNV-1a like hash → index
    let h = 2166136261 >>> 0;
    const s = `${lineName}:${minuteValue}:${lateNightMode}`;
    for (let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
    const idx = h % list.length;
    return list[idx];
  }

  function arrivalsForStation(stationId, now=new Date()){
    const weekend = isWeekend(now);
    const nowMin = now.getHours()*60 + now.getMinutes();
    const lateNightMode = isLateNight(now);
    const results = [];

    // Skip if station is suspended during late night
    if (lateNightMode && LATE_NIGHT_SUSPENDED.has(stationId)) {
      return results;
    }

    const lines = Object.keys(LINE_SERVICE);

    for (const lineName of lines){
      const service = LINE_SERVICE[lineName];
      
      // Determine which service pattern to use
      let servicePattern;
      if (lateNightMode && service.lateNight && service.lateNight.length > 0) {
        servicePattern = service.lateNight;
      } else if (lateNightMode) {
        // No late night service for this line
        continue;
      } else if (weekend) {
        servicePattern = service.weekend;
      } else {
        servicePattern = service.weekday;
      }

      const dep = expandDepartures(servicePattern);

      for (const t0 of dep){
        // Special Brown logic: direction-specific codes (only during regular hours)
        if (lineName === 'Brown' && !lateNightMode){
          // Northbound RW01N (East Heights → Santa Mora)
          const vN = ROUTE_VARIANTS.find(v=>v.code==='RW01N');
          const rN = vN.route, segN = segFor(rN);
          const idxN = rN.indexOf(stationId);
          if (idxN !== -1){
            const arr = t0 + cumulative(segN, idxN);
            for (let k=0;k<2;k++){
              const arrDay = arr + k*24*60; const minsAway = arrDay - nowMin;
              if (minsAway >= -1 && minsAway <= 360){
                results.push({ line: vN.line, color: vN.color, code: vN.code,
                  destination: rN[rN.length-1], timeMin: arrDay, minsAway,
                  stops: rN });
              }
            }
          }
          // Southbound RW01S (Santa Mora → East Heights via Roxbury Landing)
          const vS = ROUTE_VARIANTS.find(v=>v.code==='RW01S');
          const rS = vS.route, segS = segFor(rS);
          const idxS = rS.indexOf(stationId);
          if (idxS !== -1){
            const arr = t0 + cumulative(segS, idxS);
            for (let k=0;k<2;k++){
              const arrDay = arr + k*24*60; const minsAway = arrDay - nowMin;
              if (minsAway >= -1 && minsAway <= 360){
                results.push({ line: vS.line, color: vS.color, code: vS.code,
                  destination: rS[rS.length-1], timeMin: arrDay, minsAway,
                  stops: rS });
              }
            }
          }
          continue; // done with Brown for this t0
        }

        // All other lines: pick a variant once per slot, use both directions if bidirectional
        const v = pickVariant(lineName, t0, lateNightMode);
        if (!v) continue;
        const r = v.route, seg = segFor(r);

        // Skip routes that contain suspended stations during late night
        if (lateNightMode && r.some(station => LATE_NIGHT_SUSPENDED.has(station))) {
          continue;
        }

        // forward (as listed)
        const idxF = r.indexOf(stationId);
        if (idxF !== -1){
          const arr = t0 + cumulative(seg, idxF);
          for (let k=0;k<2;k++){
            const arrDay = arr + k*24*60; const minsAway = arrDay - nowMin;
            if (minsAway >= -1 && minsAway <= 360){
              results.push({ line: v.line, color: v.color, code: v.code,
                destination: r[r.length-1], timeMin: arrDay, minsAway,
                stops: r });
            }
          }
        }

        // reverse (only if bidirectional)
        if (v.bidirectional){
          const rRev = [...r].reverse();
          const segRev = segFor(rRev);
          const idxR = rRev.indexOf(stationId);
          if (idxR !== -1){
            const arr = t0 + cumulative(segRev, idxR);
            for (let k=0;k<2;k++){
              const arrDay = arr + k*24*60; const minsAway = arrDay - nowMin;
              if (minsAway >= -1 && minsAway <= 360){
                results.push({ line: v.line, color: v.color, code: v.code,
                  destination: rRev[rRev.length-1], timeMin: arrDay, minsAway,
                  stops: rRev });
              }
            }
          }
        }
      }
    }

    // Filter: never show trains whose destination equals the selected station; apply terminal rules if present
    const selectedName = STATIONS.find(s=>s.id===stationId)?.name || stationId;
    let filtered = results.filter(r=> r.destination !== selectedName);
    
    // Apply appropriate terminal rules based on late night mode
    const terminalRules = lateNightMode ? TERMINAL_RULES_LATE_NIGHT : TERMINAL_RULES;
    if (terminalRules[selectedName]){
      const allowed = new Set(terminalRules[selectedName]);
      filtered = filtered.filter(r=> allowed.has(r.destination));
    }

    filtered.sort((a,b)=> a.timeMin - b.timeMin);
    return filtered;
  }

  // ---------------------------
  // 3) UI BINDINGS
  // ---------------------------
  const stationSelect = document.getElementById('stationSelect');
  const arrivalsEl = document.getElementById('arrivals');
  const nowText = document.getElementById('nowText');
  const limitSelect = document.getElementById('limitSelect');
  const refreshBtn = document.getElementById('refreshBtn');
  const serviceState = document.getElementById('serviceState');

  function fmtMins(mins){ if (mins < -0.5) return 'departed'; if (mins <= 0.5) return 'now'; return `${Math.round(mins)} min`; }

  function renderClock(){
    const d=new Date(); const opts={ hour:'numeric', minute:'2-digit' };
    nowText.textContent = new Intl.DateTimeFormat(undefined, opts).format(d) + ' • Local time';
    
    // Update service state indicator
    const lateNight = isLateNight(d);
    if (lateNight) {
      serviceState.textContent = 'Service: Late Night';
      serviceState.className = 'pill late-night';
    } else {
      serviceState.textContent = 'Service: Normal';
      serviceState.className = 'pill';
    }
  }

  function renderStations(){
    const lateNight = isLateNight(new Date());
    
    // Filter out suspended stations during late night
    let availableStations = STATIONS;
    if (lateNight) {
      availableStations = STATIONS.filter(s => !LATE_NIGHT_SUSPENDED.has(s.id));
    }
    
    stationSelect.innerHTML = availableStations.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    
    // If current selection is suspended, switch to a default
    const currentValue = stationSelect.value;
    if (lateNight && LATE_NIGHT_SUSPENDED.has(currentValue)) {
      const def = availableStations.find(s=>s.id==='Mount Hindsboro') || availableStations[0];
      if (def) stationSelect.value = def.id;
    } else {
      const def = availableStations.find(s=>s.id==='Mount Hindsboro') || availableStations[0];
      if (def && !stationSelect.value) stationSelect.value = def.id;
    }
  }

  function renderArrivals(){
    const sid = stationSelect.value;
    const cap = parseInt(limitSelect.value, 10);
    const now = new Date();
    const lateNight = isLateNight(now);
    const list = arrivalsForStation(sid, now).slice(0, cap);

    let html = '';
    
    // Show late night service notice if applicable
    if (lateNight && LATE_NIGHT_SUSPENDED.has(sid)) {
      html = `<div class="subtle" style="padding: 12px; border: 1px solid rgba(255, 157, 0, 0.3); border-radius: 14px; background: rgba(255, 157, 0, 0.1);">
        <strong>Late Night Service (11PM-5AM)</strong><br>
        This station is closed during late night hours.
      </div>`;
    } else if (lateNight && list.length === 0) {
      html = `<div class="subtle" style="padding: 12px; border: 1px solid rgba(255, 157, 0, 0.3); border-radius: 14px; background: rgba(255, 157, 0, 0.1);">
        <strong>Late Night Service (11PM-5AM)</strong><br>
        Limited service with reduced routes and frequencies. Some lines suspended.
      </div>`;
    } else if (lateNight) {
      html = `<div class="subtle" style="padding: 12px; border: 1px solid rgba(255, 157, 0, 0.3); border-radius: 14px; background: rgba(255, 157, 0, 0.1); margin-bottom: 12px;">
        <strong>Late Night Service (11PM-5AM)</strong><br>
        Limited service with reduced routes and frequencies.
      </div>`;
    }

    html += list.map((item, i) => {
      const stopsHtml = item.stops.map(s=>`<li>${s}</li>`).join('');
      return `
        <details class="row">
          <summary style="list-style:none; display:grid; grid-template-columns:auto 1fr auto; gap:12px; align-items:center; cursor:pointer;">
            <div class="dot" style="background:${item.color}"></div>
            <div>
              <div class="lineTag">${item.line} Line</div>
              <div class="dest">to ${item.destination} <span class="pill" style="margin-left:6px;">${item.code}</span></div>
            </div>
            <div class="mins">${fmtMins(item.minsAway)}</div>
          </summary>
          <div style="margin:10px 0 2px 26px;">
            <div class="subtle" style="margin-bottom:6px;">Making stops at…</div>
            <ul style="margin:0; padding-left:16px; line-height:1.6;">
              ${stopsHtml}
            </ul>
          </div>
        </details>`;
    }).join('');

    if (!html.includes('class="row"') && !lateNight) {
      html += `<div class="subtle">No upcoming trains in the next 6 hours.</div>`;
    }

    arrivalsEl.innerHTML = html;
  }

  renderStations();
  renderClock();
  renderArrivals();

  setInterval(()=>{ renderClock(); renderArrivals(); renderStations(); }, 20000);
  stationSelect.addEventListener('change', renderArrivals);
  limitSelect.addEventListener('change', renderArrivals);
  refreshBtn.addEventListener('click', ()=>{ renderClock(); renderArrivals(); renderStations(); });

  // ---------------------------
  // 4) OPTIONAL: basic offline cache (works after first load)
  // ---------------------------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      const sw = URL.createObjectURL(new Blob([
        `self.addEventListener('install', e=>{ e.waitUntil(caches.open('borail-v1').then(c=>c.addAll(['./']))); });
`+
        `self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=>r || fetch(e.request))); });`
      ], { type: 'text/javascript' }));
      navigator.serviceWorker.register(sw).catch(()=>{});
    });
  }
  </script>
</body>
</html>
